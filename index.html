<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>SKV Auto DJ Player v3.4 - Simple</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root {
      --bg: #0f172a; --card: #111827; --accent: #38bdf8;
      --text-main: #e5e7eb; --text-muted: #9ca3af; --danger: #f97373; --success: #22c55e;
      --spotify: #1DB954;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: system-ui, sans-serif;
      background: linear-gradient(135deg, #1e293b 0, #020617 100%);
      color: var(--text-main); min-height: 100vh;
      display: flex; align-items: center; justify-content: center; padding: 16px;
    }
    .app {
      width: 100%; max-width: 720px;
      background: rgba(15,23,42,0.95);
      border-radius: 18px; padding: 24px;
      border: 1px solid rgba(148,163,184,0.35);
    }
    .app-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    .title-block h1 { font-size: 1.3rem; margin-bottom: 4px; }
    .title-block p { color: var(--text-muted); font-size: 0.9rem; }
    .tag {
      padding: 4px 10px; border-radius: 999px; font-size: 0.75rem;
      background: rgba(15,23,42,0.85); border: 1px solid rgba(148,163,184,0.55);
      display: inline-flex; align-items: center; gap: 6px;
    }
    .tag-dot { width: 7px; height: 7px; border-radius: 50%; background: var(--success); }
    .tag-dot.offline { background: var(--danger); }
    .spotify-connect {
      background: var(--spotify); color: #000; border: none;
      padding: 10px 20px; border-radius: 999px; font-weight: 700;
      cursor: pointer; display: inline-flex; align-items: center; gap: 8px;
    }
    .spotify-connect.connected { background: #059669; color: #fff; }
    .current-card {
      margin-bottom: 16px; border-radius: 14px; padding: 16px;
      background: rgba(30,41,59,0.6); border-left: 4px solid var(--accent);
    }
    .current-label { font-size: 0.8rem; color: var(--text-muted); text-transform: uppercase; margin-bottom: 8px; }
    .current-title { font-size: 1.1rem; margin-bottom: 8px; }
    .current-type { font-size: 0.8rem; color: var(--text-muted); text-transform: uppercase; }
    .current-artist { font-size: 0.9rem; margin: 8px 0; }
    .current-index { font-size: 0.85rem; color: var(--text-muted); }
    .controls { display: flex; flex-wrap: wrap; gap: 8px; margin: 16px 0; }
    button { border: none; cursor: pointer; font: inherit; }
    .btn-main {
      background: var(--success); color: #0b1120; padding: 8px 16px;
      border-radius: 999px; font-weight: 600;
    }
    .btn-secondary {
      background: rgba(15,23,42,0.96); color: var(--text-main);
      border: 1px solid rgba(148,163,184,0.6); padding: 8px 16px; border-radius: 999px;
    }
    .btn-spotify {
      background: var(--spotify); color: #000; padding: 8px 16px;
      border-radius: 999px; font-weight: 600;
    }
    .btn-ghost { background: transparent; color: var(--text-muted); padding: 8px 12px; }
    .playback-controls {
      display: flex; align-items: center; gap: 12px; margin: 16px 0;
      padding: 12px; background: rgba(0,0,0,0.3); border-radius: 12px;
    }
    .playback-btn {
      width: 40px; height: 40px; border-radius: 50%;
      background: var(--text-main); color: var(--bg);
      display: flex; align-items: center; justify-content: center;
      font-size: 1.2rem;
    }
    .volume-slider {
      flex: 1; height: 4px; border-radius: 2px;
      background: rgba(148,163,184,0.3); appearance: none; cursor: pointer;
    }
    .list {
      max-height: 220px; overflow-y: auto;
      border: 1px dashed rgba(148,163,184,0.45);
      border-radius: 12px; padding: 12px; margin-top: 16px;
    }
    .list-item {
      padding: 8px; border-radius: 8px; margin-bottom: 4px;
      cursor: pointer; display: flex; align-items: center; gap: 8px;
      border-left: 4px solid transparent;
    }
    .list-item:hover { background: rgba(30,64,175,0.5); }
    .list-item.active { background: rgba(37,99,235,0.7); }
    .badge {
      font-size: 0.7rem; padding: 2px 8px; border-radius: 999px;
      background: rgba(15,23,42,0.96); border: 1px solid rgba(148,163,184,0.6);
    }
    .list-title-text { font-weight: 500; }
    .list-artist { font-size: 0.75rem; color: var(--text-muted); }
    .hidden { display: none !important; }
    .version { position: fixed; bottom: 8px; right: 8px; font-size: 0.7rem; opacity: 0.5; }
  </style>
</head>
<body>
<div class="app">
  <header class="app-header">
    <div class="title-block">
      <h1>SKV Auto DJ ¬∑ Spotify</h1>
      <p>–ü–æ –æ—á–µ—Ä–µ–¥–∏ –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç –∞–ª—å–±–æ–º—ã –∏ –ø–ª–µ–π–ª–∏—Å—Ç—ã</p>
    </div>
    <div style="display:flex;gap:8px;align-items:center;">
      <button class="spotify-connect" id="btnConnectSpotify">
        <span>üéµ</span><span id="connectSpotifyText">–ü–æ–¥–∫–ª—é—á–∏—Ç—å Spotify</span>
      </button>
      <div class="tag">
        <span class="tag-dot" id="statusDot"></span>
        <span id="statusText">v3.4</span>
      </div>
    </div>
  </header>

  <section class="current-card" id="currentCard">
    <div class="current-label">–¢–µ–∫—É—â–∏–π —Ä–µ–ª–∏–∑</div>
    <h2 class="current-title" id="currentTitle">–ó–∞–≥—Ä—É–∑–∫–∞...</h2>
    <div class="current-type" id="currentType">‚Äî</div>
    <div class="current-artist" id="currentArtist">‚Äî</div>
    <div class="current-index" id="currentIndex">0 / 0</div>
    
    <div class="controls">
      <button class="btn-main" id="btnOpen">‚ñ∂ –û—Ç–∫—Ä—ã—Ç—å –≤ Spotify</button>
      <button class="btn-spotify hidden" id="btnPlayPause">‚ñ∂ –ò–≥—Ä–∞—Ç—å</button>
      <button class="btn-secondary" id="btnPrev">‚ü®‚ü® –ù–∞–∑–∞–¥</button>
      <button class="btn-secondary" id="btnNext">‚ü©‚ü© –í–ø–µ—Ä—ë–¥</button>
    </div>
    
    <div class="playback-controls hidden" id="playbackControls">
      <button class="playback-btn" id="btnPrevTrack">‚èÆ</button>
      <button class="playback-btn" id="btnPlayPauseTrack">‚ñ∂</button>
      <button class="playback-btn" id="btnNextTrack">‚è≠</button>
      <input type="range" class="volume-slider" id="volumeSlider" min="0" max="100" value="50" />
    </div>
  </section>

  <div class="list" id="list">
    <div style="color:var(--text-muted);margin-bottom:8px;">–û—á–µ—Ä–µ–¥—å —Ä–µ–ª–∏–∑–æ–≤</div>
  </div>
</div>

<div class="version">v3.4-Simple</div>

<script src="https://sdk.scdn.co/spotify-player.js"></script>
<script type="module">
const SPOTIFY_CLIENT_ID = 'c4699c1d0e98455fab4d9307b671f80c';
const REDIRECT_URI = window.location.origin + '/callback';
const SCOPES = 'streaming user-read-playback-state user-modify-playback-state user-read-currently-playing';

const CONFIG = {
  STORAGE_KEY: 'skv-autodj-v10',
  DEFAULT_RELEASES: [
    { url: 'https://open.spotify.com/album/2SMf2fZr3arg0Vw63T5nzQ', type: 'album' },
    { url: 'https://open.spotify.com/album/4eYmRpMI7nUwnhEEPPwDyu', type: 'album' },
    { url: 'https://open.spotify.com/album/2ApRKWzy7nuVboZJIrttm5', type: 'album' },
    { url: 'https://open.spotify.com/playlist/6ao5XF0UXFW4YiBbaPVJf2', type: 'playlist' },
    { url: 'https://open.spotify.com/album/5IIM2OiO6Mm3OSYgrV4IXa', type: 'album' },
    { url: 'https://open.spotify.com/album/6QBs6v06fJ3LHMiX9weH79', type: 'album' },
    { url: 'https://open.spotify.com/album/2Kr2Dii8vxP3wcjQpdNaHA', type: 'album' },
    { url: 'https://open.spotify.com/playlist/2tVTJxWEvHrIjDroVO0vsk', type: 'playlist' }
  ]
};

const Storage = {
  load() { try { return JSON.parse(localStorage.getItem(CONFIG.STORAGE_KEY)); } catch { return null; } },
  save(data) { localStorage.setItem(CONFIG.STORAGE_KEY, JSON.stringify(data)); }
};

const SpotifyAuth = {
  token: null, refreshToken: null, expiresAt: 0,
  async connect() {
    const verifier = crypto.randomUUID().replace(/-/g, '');
    const challenge = await crypto.subtle.digest('SHA-256', new TextEncoder().encode(verifier));
    const codeChallenge = btoa(String.fromCharCode(...new Uint8Array(challenge))).replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
    localStorage.setItem('spotify_verifier', verifier);
    const url = new URL('https://accounts.spotify.com/authorize');
    url.searchParams.set('client_id', SPOTIFY_CLIENT_ID);
    url.searchParams.set('redirect_uri', REDIRECT_URI);
    url.searchParams.set('response_type', 'code');
    url.searchParams.set('code_challenge_method', 'S256');
    url.searchParams.set('code_challenge', codeChallenge);
    url.searchParams.set('scope', SCOPES);
    window.location.href = url.toString();
  },
  async getToken(code) {
    const verifier = localStorage.getItem('spotify_verifier');
    const res = await fetch('https://accounts.spotify.com/api/token', {
      method: 'POST',
      headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
      body: new URLSearchParams({
        client_id: SPOTIFY_CLIENT_ID, grant_type: 'authorization_code',
        code, redirect_uri: REDIRECT_URI, code_verifier: verifier
      })
    });
    const data = await res.json();
    this.token = data.access_token;
    this.refreshToken = data.refresh_token;
    this.expiresAt = Date.now() + data.expires_in * 1000;
    localStorage.setItem('spotify_token', this.token);
    localStorage.setItem('spotify_refresh', this.refreshToken);
    localStorage.setItem('spotify_expires', this.expiresAt.toString());
    return this.token;
  },
  async getTokenSilent() {
    const stored = localStorage.getItem('spotify_token');
    const expires = parseInt(localStorage.getItem('spotify_expires') || '0');
    if (stored && Date.now() < expires - 60000) return stored;
    const refresh = localStorage.getItem('spotify_refresh');
    if (!refresh) return null;
    const res = await fetch('https://accounts.spotify.com/api/token', {
      method: 'POST',
      headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
      body: new URLSearchParams({
        client_id: SPOTIFY_CLIENT_ID, grant_type: 'refresh_token',
        refresh_token: refresh
      })
    });
    const data = await res.json();
    this.token = data.access_token;
    this.expiresAt = Date.now() + data.expires_in * 1000;
    localStorage.setItem('spotify_token', this.token);
    localStorage.setItem('spotify_expires', this.expiresAt.toString());
    return this.token;
  },
  isConnected() { return !!localStorage.getItem('spotify_refresh'); }
};

let player = null;
let deviceId = null;
let isPlaying = false;
let queue = [];
let currentIdx = 0;

// –≠–ª–µ–º–µ–Ω—Ç—ã
const els = {
  btnConnectSpotify: document.getElementById('btnConnectSpotify'),
  connectSpotifyText: document.getElementById('connectSpotifyText'),
  statusDot: document.getElementById('statusDot'),
  currentTitle: document.getElementById('currentTitle'),
  currentType: document.getElementById('currentType'),
  currentArtist: document.getElementById('currentArtist'),
  currentIndex: document.getElementById('currentIndex'),
  btnOpen: document.getElementById('btnOpen'),
  btnPlayPause: document.getElementById('btnPlayPause'),
  btnPrev: document.getElementById('btnPrev'),
  btnNext: document.getElementById('btnNext'),
  playbackControls: document.getElementById('playbackControls'),
  btnPlayPauseTrack: document.getElementById('btnPlayPauseTrack'),
  btnPrevTrack: document.getElementById('btnPrevTrack'),
  btnNextTrack: document.getElementById('btnNextTrack'),
  volumeSlider: document.getElementById('volumeSlider'),
  list: document.getElementById('list'),
  currentCard: document.getElementById('currentCard')
};

async function initSpotify() {
  if (!window.Spotify) { console.error('SDK not loaded'); return; }
  
  player = new Spotify.Player({
    name: 'SKV Auto DJ',
    getOAuthToken: async cb => {
      const token = await SpotifyAuth.getTokenSilent();
      cb(token);
    },
    volume: 0.5
  });
  
  player.addListener('ready', ({ device_id }) => {
    deviceId = device_id;
    console.log('‚úÖ Device:', device_id);
  });
  
  player.addListener('not_ready', () => {
    deviceId = null;
    console.log('‚ùå Device disconnected');
  });
  
  player.addListener('player_state_changed', state => {
    if (!state) return;
    isPlaying = !state.paused;
    updatePlayButton();
  });
  
  await player.connect();
}

function updatePlayButton() {
  if (els.btnPlayPause) {
    els.btnPlayPause.textContent = isPlaying ? '‚è∏ –ü–∞—É–∑–∞' : '‚ñ∂ –ò–≥—Ä–∞—Ç—å';
  }
  if (els.btnPlayPauseTrack) {
    els.btnPlayPauseTrack.textContent = isPlaying ? '‚è∏' : '‚ñ∂';
  }
}

async function playCurrent() {
  const item = queue[currentIdx];
  if (!item) return;
  
  const uri = getSpotifyUri(item.url);
  if (!uri) { window.open(item.url, '_blank'); return; }
  
  console.log('üéµ Playing:', item.title, uri);
  
  const token = await SpotifyAuth.getTokenSilent();
  if (!token || !deviceId) {
    alert('Spotify –Ω–µ –ø–æ–¥–∫–ª—é—á—ë–Ω –∏–ª–∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ');
    return;
  }
  
  try {
    // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ
    await fetch('https://api.spotify.com/v1/me/player', {
      method: 'PUT',
      headers: { 'Authorization': `Bearer ${token}` },
      body: JSON.stringify({ device_ids: [deviceId], play: true })
    });
    
    // –ó–∞–ø—É—Å–∫–∞–µ–º –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ
    const res = await fetch(`https://api.spotify.com/v1/me/player/play?device_id=${deviceId}`, {
      method: 'PUT',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ uris: [uri] })
    });
    
    if (res.ok) {
      console.log('‚úÖ Playing started');
    } else {
      const err = await res.text();
      console.error('‚ùå Play failed:', err);
      alert('–û—à–∏–±–∫–∞ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è: ' + res.status);
    }
  } catch (e) {
    console.error('‚ùå Error:', e);
    alert('–û—à–∏–±–∫–∞: ' + e.message);
  }
}

function getSpotifyUri(url) {
  const clean = url.split('?')[0];
  const match = clean.match(/(?:album|playlist|track)\/([a-zA-Z0-9]+)/);
  if (match) {
    const type = clean.includes('album') ? 'album' : clean.includes('playlist') ? 'playlist' : 'track';
    return `spotify:${type}:${match[1]}`;
  }
  return null;
}

function getArtistForTitle(title) {
  const hasJazzOrBlues = title.toLowerCase().includes('jazz') || title.toLowerCase().includes('blues');
  if (hasJazzOrBlues) {
    return { artist: 'Jazz music cafe', color: '#a78bfa' };
  }
  return { artist: 'Wordless Melodies Studio', color: '#38bdf8' };
}

async function fetchMetadata() {
  const releases = [];
  for (const item of CONFIG.DEFAULT_RELEASES) {
    try {
      const res = await fetch(`https://open.spotify.com/oembed?url=${encodeURIComponent(item.url)}&format=json`);
      if (res.ok) {
        const data = await res.json();
        const artistData = getArtistForTitle(data.title);
        releases.push({
          title: data.title,
          artist: artistData.artist,
          accentColor: artistData.color,
          type: item.type,
          url: item.url
        });
      }
    } catch (e) {
      console.warn('Failed to fetch:', item.url);
    }
  }
  return releases;
}

function render() {
  const item = queue[currentIdx];
  if (!item) return;
  
  els.currentTitle.textContent = item.title;
  els.currentType.textContent = item.type === 'playlist' ? '–ü–õ–ï–ô–õ–ò–°–¢' : '–ê–õ–¨–ë–û–ú';
  els.currentArtist.textContent = item.artist;
  els.currentArtist.style.color = item.accentColor || '#38bdf8';
  els.currentCard.style.borderLeftColor = item.accentColor || '#38bdf8';
  els.currentIndex.textContent = `${currentIdx + 1} / ${queue.length}`;
  
  // –†–µ–Ω–¥–µ—Ä–∏–º —Å–ø–∏—Å–æ–∫
  els.list.innerHTML = '<div style="color:var(--text-muted);margin-bottom:8px;">–û—á–µ—Ä–µ–¥—å —Ä–µ–ª–∏–∑–æ–≤</div>';
  queue.forEach((item, i) => {
    const div = document.createElement('div');
    div.className = 'list-item' + (i === currentIdx ? ' active' : '');
    div.style.borderLeftColor = item.accentColor || '#38bdf8';
    div.innerHTML = `
      <span class="badge">${item.type.toUpperCase()}</span>
      <div style="flex:1">
        <div class="list-title-text">üéµ ${item.title}</div>
        <div class="list-artist">${item.artist}</div>
      </div>
    `;
    div.onclick = () => {
      currentIdx = i;
      render();
      Storage.save({ queue, currentIdx });
    };
    els.list.appendChild(div);
  });
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
(async () => {
  // –ó–∞–≥—Ä—É–∂–∞–µ–º –æ—á–µ—Ä–µ–¥—å
  const saved = Storage.load();
  if (saved && saved.queue) {
    queue = saved.queue;
    currentIdx = saved.currentIdx || 0;
  } else {
    queue = await fetchMetadata();
    currentIdx = 0;
    Storage.save({ queue, currentIdx });
  }
  
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
  const connected = SpotifyAuth.isConnected();
  if (connected) {
    els.btnConnectSpotify.classList.add('connected');
    els.connectSpotifyText.textContent = 'Spotify –ø–æ–¥–∫–ª—é—á—ë–Ω';
    els.statusDot.classList.remove('offline');
    els.playbackControls.classList.remove('hidden');
    els.btnPlayPause.classList.remove('hidden');
    await initSpotify();
  }
  
  render();
  
  // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
  els.btnConnectSpotify.onclick = async () => {
    if (SpotifyAuth.isConnected()) {
      localStorage.removeItem('spotify_token');
      localStorage.removeItem('spotify_refresh');
      localStorage.removeItem('spotify_expires');
      location.reload();
    } else {
      await SpotifyAuth.connect();
    }
  };
  
  els.btnOpen.onclick = () => {
    const item = queue[currentIdx];
    if (item) window.open(item.url, '_blank');
  };
  
  els.btnPlayPause.onclick = () => playCurrent();
  els.btnPrev.onclick = () => { currentIdx = (currentIdx - 1 + queue.length) % queue.length; render(); Storage.save({ queue, currentIdx }); };
  els.btnNext.onclick = () => { currentIdx = (currentIdx + 1) % queue.length; render(); Storage.save({ queue, currentIdx }); };
  
  els.btnPlayPauseTrack.onclick = () => player.togglePlay();
  els.btnPrevTrack.onclick = () => player.previousTrack();
  els.btnNextTrack.onclick = () => player.nextTrack();
  els.volumeSlider.oninput = (e) => player.setVolume(e.target.value / 100);
  
  // Callback
  const urlParams = new URLSearchParams(window.location.search);
  const code = urlParams.get('code');
  if (code) {
    await SpotifyAuth.getToken(code);
    window.history.replaceState({}, document.title, window.location.pathname);
    await initSpotify();
    els.btnConnectSpotify.classList.add('connected');
    els.connectSpotifyText.textContent = 'Spotify –ø–æ–¥–∫–ª—é—á—ë–Ω';
    els.statusDot.classList.remove('offline');
    els.playbackControls.classList.remove('hidden');
    els.btnPlayPause.classList.remove('hidden');
  }
})();
</script>
</body>
</html>
