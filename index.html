<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>SKV Auto DJ v3.7 - Simple</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body { font-family: system-ui; background: #0f172a; color: #e5e7eb; padding: 20px; }
    .app { max-width: 720px; margin: 0 auto; background: #1e293b; padding: 24px; border-radius: 12px; }
    button { padding: 10px 20px; margin: 8px; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; }
    .btn-primary { background: #22c55e; color: #000; font-weight: 600; }
    .btn-secondary { background: #334155; color: #fff; }
    .hidden { display: none; }
    .error { background: #fee2e2; color: #dc2626; padding: 12px; border-radius: 8px; margin: 16px 0; }
    .success { background: #dcfce7; color: #16a34a; padding: 12px; border-radius: 8px; margin: 16px 0; }
    .item { padding: 12px; margin: 8px 0; background: #334155; border-radius: 8px; cursor: pointer; border-left: 4px solid transparent; }
    .item.active { background: #2563eb; border-left-color: #38bdf8; }
  </style>
</head>
<body>
<div class="app">
  <h1>üéµ SKV Auto DJ</h1>
  
  <div id="status"></div>
  
  <div style="margin: 20px 0;">
    <button class="btn-primary" id="btnConnect">üîó –ü–æ–¥–∫–ª—é—á–∏—Ç—å Spotify</button>
    <button class="btn-primary hidden" id="btnPlay">‚ñ∂ –ò–≥—Ä–∞—Ç—å</button>
    <button class="btn-secondary" id="btnPrev">‚ü®‚ü® –ù–∞–∑–∞–¥</button>
    <button class="btn-secondary" id="btnNext">‚ü©‚ü© –í–ø–µ—Ä—ë–¥</button>
  </div>
  
  <div id="current" style="margin: 20px 0; padding: 16px; background: #1e293b; border-radius: 8px;"></div>
  
  <div id="list"></div>
</div>

<script type="module">
const CLIENT_ID = 'c4699c1d0e98455fab4d9307b671f80c';
const REDIRECT = window.location.origin + '/callback';
const SCOPES = 'streaming user-read-playback-state user-modify-playback-state';

let token = null;
let queue = [];
let idx = 0;

const els = {
  status: document.getElementById('status'),
  current: document.getElementById('current'),
  list: document.getElementById('list'),
  btnConnect: document.getElementById('btnConnect'),
  btnPlay: document.getElementById('btnPlay'),
  btnPrev: document.getElementById('btnPrev'),
  btnNext: document.getElementById('btnNext')
};

function showStatus(msg, isError = false) {
  els.status.innerHTML = `<div class="${isError ? 'error' : 'success'}">${msg}</div>`;
}

async function connect() {
  const verifier = Array.from(crypto.getRandomValues(new Uint8Array(32)), b => b.toString(16).padStart(2,'0')).join('');
  localStorage.setItem('verifier', verifier);
  
  const challenge = await crypto.subtle.digest('SHA-256', new TextEncoder().encode(verifier));
  const codeChallenge = btoa(String.fromCharCode(...new Uint8Array(challenge))).replace(/\+/g,'-').replace(/\//g,'_').replace(/=/g,'');
  
  const url = `https://accounts.spotify.com/authorize?client_id=${CLIENT_ID}&response_type=code&redirect_uri=${encodeURIComponent(REDIRECT)}&code_challenge_method=S256&code_challenge=${codeChallenge}&scope=${encodeURIComponent(SCOPES)}`;
  
  window.location.href = url;
}

async function getToken(code) {
  const verifier = localStorage.getItem('verifier');
  const res = await fetch('https://accounts.spotify.com/api/token', {
    method: 'POST',
    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
    body: `client_id=${CLIENT_ID}&grant_type=authorization_code&code=${code}&redirect_uri=${encodeURIComponent(REDIRECT)}&code_verifier=${verifier}`
  });
  
  if (!res.ok) throw new Error('Failed: ' + res.status);
  
  const data = await res.json();
  token = data.access_token;
  localStorage.setItem('token', token);
  localStorage.setItem('refresh', data.refresh_token);
  showStatus('‚úÖ Spotify –ø–æ–¥–∫–ª—é—á—ë–Ω!');
  els.btnConnect.classList.add('hidden');
  els.btnPlay.classList.remove('hidden');
}

async function loadQueue() {
  const saved = localStorage.getItem('queue');
  if (saved) {
    queue = JSON.parse(saved);
    idx = parseInt(localStorage.getItem('idx') || '0');
    return;
  }
  
  const urls = [
    'https://open.spotify.com/album/2SMf2fZr3arg0Vw63T5nzQ',
    'https://open.spotify.com/album/4eYmRpMI7nUwnhEEPPwDyu',
    'https://open.spotify.com/album/2ApRKWzy7nuVboZJIrttm5',
    'https://open.spotify.com/playlist/6ao5XF0UXFW4YiBbaPVJf2',
    'https://open.spotify.com/album/5IIM2OiO6Mm3OSYgrV4IXa',
    'https://open.spotify.com/album/6QBs6v06fJ3LHMiX9weH79',
    'https://open.spotify.com/album/2Kr2Dii8vxP3wcjQpdNaHA',
    'https://open.spotify.com/playlist/2tVTJxWEvHrIjDroVO0vsk'
  ];
  
  for (const url of urls) {
    try {
      const res = await fetch(`https://open.spotify.com/oembed?url=${encodeURIComponent(url)}&format=json`);
      if (res.ok) {
        const data = await res.json();
        queue.push({ title: data.title, artist: data.author_name, url, type: url.includes('playlist') ? 'playlist' : 'album' });
      }
    } catch (e) { console.warn('Failed:', url); }
  }
  
  localStorage.setItem('queue', JSON.stringify(queue));
}

function render() {
  const item = queue[idx];
  if (!item) return;
  
  els.current.innerHTML = `
    <h2>${item.title}</h2>
    <p style="color: #9ca3af">${item.artist}</p>
    <p style="color: #9ca3af">${idx + 1} / ${queue.length}</p>
  `;
  
  els.list.innerHTML = queue.map((item, i) => `
    <div class="item ${i === idx ? 'active' : ''}" onclick="window.selectItem(${i})">
      <strong>${item.title}</strong><br>
      <small style="color: #9ca3af">${item.artist}</small>
    </div>
  `).join('');
}

window.selectItem = (i) => { idx = i; render(); localStorage.setItem('idx', idx); };

async function play() {
  const item = queue[idx];
  if (!item) return;
  
  showStatus('‚è≥ –û—Ç–∫—Ä—ã–≤–∞—é...');
  
  // üîß –ü–†–û–°–¢–û–ï –†–ï–®–ï–ù–ò–ï: –ü—Ä–æ—Å—Ç–æ –æ—Ç–∫—Ä—ã–≤–∞–µ–º –≤ Spotify
  window.open(item.url, '_blank');
  
  showStatus('‚úÖ –û—Ç–∫—Ä—ã—Ç–æ –≤ –Ω–æ–≤–æ–π –≤–∫–ª–∞–¥–∫–µ! –í–∫–ª—é—á–∏ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ —Ç–∞–º.');
}

// Init
(async () => {
  token = localStorage.getItem('token');
  if (token) {
    els.btnConnect.classList.add('hidden');
    els.btnPlay.classList.remove('hidden');
    showStatus('‚úÖ Spotify –ø–æ–¥–∫–ª—é—á—ë–Ω');
  }
  
  await loadQueue();
  render();
  
  els.btnConnect.onclick = connect;
  els.btnPlay.onclick = play;
  els.btnPrev.onclick = () => { idx = (idx - 1 + queue.length) % queue.length; render(); localStorage.setItem('idx', idx); };
  els.btnNext.onclick = () => { idx = (idx + 1) % queue.length; render(); localStorage.setItem('idx', idx); };
  
  const code = new URLSearchParams(window.location.search).get('code');
  if (code) {
    try {
      await getToken(code);
      window.history.replaceState({}, '', window.location.pathname);
      await loadQueue();
      render();
    } catch (e) {
      showStatus('‚ùå –û—à–∏–±–∫–∞: ' + e.message, true);
    }
  }
})();
</script>
</body>
</html>
