<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>SKV Auto DJ v4.6</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root {
      --bg: #0f172a; --card: #1e293b; --accent: #38bdf8;
      --text: #e5e7eb; --muted: #9ca3af; --success: #22c55e; --danger: #f97373;
      --spotify: #1db954;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: system-ui, -apple-system, sans-serif;
      background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
      color: var(--text); min-height: 100vh; padding: 20px;
    }
    .container { max-width: 800px; margin: 0 auto; }
    header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
    h1 { font-size: 1.8rem; }
    .badge { background: var(--spotify); color: #000; padding: 6px 12px; border-radius: 20px; font-size: 0.85rem; font-weight: 600; }
    
    .card { background: var(--card); border-radius: 16px; padding: 24px; margin-bottom: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
    .current-track { border-left: 4px solid var(--accent); }
    .label { font-size: 0.75rem; text-transform: uppercase; color: var(--muted); letter-spacing: 0.1em; margin-bottom: 8px; }
    .title { font-size: 1.4rem; margin-bottom: 8px; }
    .artist { color: var(--accent); font-size: 1rem; margin-bottom: 12px; }
    .meta { color: var(--muted); font-size: 0.9rem; }
    
    .controls { display: flex; gap: 10px; margin-top: 20px; flex-wrap: wrap; }
    button {
      padding: 12px 24px; border: none; border-radius: 999px;
      font-size: 0.95rem; font-weight: 600; cursor: pointer;
      transition: all 0.2s; display: inline-flex; align-items: center; gap: 8px;
    }
    button:hover { transform: translateY(-2px); }
    .btn-primary { background: var(--success); color: #000; }
    .btn-spotify { background: var(--spotify); color: #000; }
    .btn-secondary { background: rgba(148,163,184,0.2); color: var(--text); border: 1px solid rgba(148,163,184,0.3); }
    .btn-edit { background: rgba(56,189,248,0.2); color: var(--accent); border: 1px solid var(--accent); }
    .btn-delete { background: rgba(249,115,115,0.2); color: var(--danger); border: 1px solid var(--danger); }
    
    .player-controls { display: flex; align-items: center; gap: 16px; margin-top: 20px; padding: 16px; background: rgba(0,0,0,0.2); border-radius: 12px; }
    .player-btn { width: 44px; height: 44px; border-radius: 50%; background: var(--text); color: var(--bg); display: flex; align-items: center; justify-content: center; font-size: 1.2rem; }
    .volume { flex: 1; }
    .volume input[type="range"] { width: 100%; height: 4px; background: rgba(148,163,184,0.3); border-radius: 2px; appearance: none; }
    .volume input[type="range"]::-webkit-slider-thumb { appearance: none; width: 14px; height: 14px; background: var(--text); border-radius: 50%; cursor: pointer; }
    
    .queue-item { padding: 12px; margin: 8px 0; background: rgba(15,23,42,0.5); border-radius: 8px; cursor: pointer; border-left: 4px solid transparent; transition: all 0.2s; display: flex; align-items: center; justify-content: space-between; }
    .queue-item:hover { background: rgba(30,64,175,0.3); transform: translateX(4px); }
    .queue-item.active { background: rgba(37,99,235,0.4); border-left-color: var(--accent); }
    .queue-info { flex: 1; }
    .queue-title { font-weight: 600; margin-bottom: 4px; }
    .queue-artist { font-size: 0.85rem; color: var(--muted); }
    .queue-actions { display: flex; gap: 8px; }
    .badge-type { font-size: 0.7rem; padding: 2px 8px; border-radius: 4px; background: rgba(148,163,184,0.2); margin-right: 8px; }
    
    .add-form { margin-top: 16px; padding: 16px; background: rgba(15,23,42,0.5); border-radius: 8px; }
    .form-group { margin-bottom: 12px; }
    .form-group label { display: block; margin-bottom: 4px; color: var(--muted); font-size: 0.85rem; }
    .form-group input, .form-group select { width: 100%; padding: 8px 12px; border: 1px solid rgba(148,163,184,0.3); border-radius: 6px; background: rgba(15,23,42,0.8); color: var(--text); }
    .form-group input:focus, .form-group select:focus { outline: none; border-color: var(--accent); }
    
    .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.8); display: none; align-items: center; justify-content: center; z-index: 1000; }
    .modal-overlay.show { display: flex; }
    .modal { background: var(--card); padding: 24px; border-radius: 16px; max-width: 500px; width: 90%; }
    .modal h2 { margin-bottom: 16px; }
    
    .alert { padding: 12px; border-radius: 8px; margin-bottom: 16px; }
    .alert-error { background: rgba(249,115,115,0.2); border: 1px solid var(--danger); color: var(--danger); }
    .alert-success { background: rgba(34,197,94,0.2); border: 1px solid var(--success); color: var(--success); }
    .alert-warning { background: rgba(251,191,36,0.2); border: 1px solid #fbbf24; color: #fbbf24; }
    .hidden { display: none !important; }
    
    .sdk-status { padding: 8px 12px; border-radius: 6px; margin-bottom: 12px; font-size: 0.9rem; }
    .sdk-status.loading { background: rgba(56,189,248,0.2); color: var(--accent); }
    .sdk-status.ready { background: rgba(34,197,94,0.2); color: var(--success); }
    .sdk-status.error { background: rgba(249,115,115,0.2); color: var(--danger); }
  </style>
</head>
<body>
<div class="container">
  <header>
    <h1>üéµ SKV Auto DJ</h1>
    <div style="display:flex;gap:12px;align-items:center;">
      <span class="badge" id="statusBadge">v4.6</span>
      <button class="btn-spotify" id="btnConnect">üîó –ü–æ–¥–∫–ª—é—á–∏—Ç—å</button>
    </div>
  </header>

  <div id="alert"></div>
  <div id="sdkStatus" class="sdk-status loading hidden">üîÑ –ó–∞–≥—Ä—É–∑–∫–∞ Spotify SDK...</div>

  <div class="card current-track">
    <div class="label">–°–µ–π—á–∞—Å –≤—ã–±—Ä–∞–Ω</div>
    <div class="title" id="currentTitle">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
    <div class="artist" id="currentArtist">‚Äî</div>
    <div class="meta" id="currentIndex">‚Äî</div>
    
    <div class="controls">
      <button class="btn-primary" id="btnOpen">üîó –û—Ç–∫—Ä—ã—Ç—å –≤ Spotify</button>
      <button class="btn-spotify" id="btnPlay">‚ñ∂ –ò–≥—Ä–∞—Ç—å –≤ —ç—Ç–æ–º –æ–∫–Ω–µ</button>
      <button class="btn-secondary" id="btnPrev">‚ü®‚ü® –ù–∞–∑–∞–¥</button>
      <button class="btn-secondary" id="btnNext">‚ü©‚ü© –í–ø–µ—Ä—ë–¥</button>
    </div>
    
    <div class="player-controls hidden" id="playerControls">
      <button class="player-btn" id="btnPrevTrack">‚èÆ</button>
      <button class="player-btn" id="btnPlayPause">‚ñ∂</button>
      <button class="player-btn" id="btnNextTrack">‚è≠</button>
      <div class="volume">
        <input type="range" id="volumeSlider" min="0" max="100" value="50" />
      </div>
    </div>
  </div>

  <div class="card">
    <div class="label">–û—á–µ—Ä–µ–¥—å —Ä–µ–ª–∏–∑–æ–≤</div>
    <div id="queueList"></div>
    
    <details class="add-form">
      <summary style="cursor:pointer;color:var(--accent);margin-bottom:12px;">+ –î–æ–±–∞–≤–∏—Ç—å —Ä–µ–ª–∏–∑</summary>
      <form id="addForm">
        <div class="form-group">
          <label>–ù–∞–∑–≤–∞–Ω–∏–µ</label>
          <input type="text" id="addTitle" required />
        </div>
        <div class="form-group">
          <label>–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å</label>
          <input type="text" id="addArtist" />
        </div>
        <div class="form-group">
          <label>–¢–∏–ø</label>
          <select id="addType">
            <option value="album">–ê–ª—å–±–æ–º</option>
            <option value="playlist">–ü–ª–µ–π–ª–∏—Å—Ç</option>
            <option value="track">–¢—Ä–µ–∫</option>
          </select>
        </div>
        <div class="form-group">
          <label>Spotify URL</label>
          <input type="url" id="addUrl" required placeholder="https://open.spotify.com/..." />
        </div>
        <button type="submit" class="btn-primary">–î–æ–±–∞–≤–∏—Ç—å</button>
      </form>
    </details>
  </div>
</div>

<div class="modal-overlay" id="editModal">
  <div class="modal">
    <h2>‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</h2>
    <form id="editForm">
      <input type="hidden" id="editIndex" />
      <div class="form-group">
        <label>–ù–∞–∑–≤–∞–Ω–∏–µ</label>
        <input type="text" id="editTitle" required />
      </div>
      <div class="form-group">
        <label>–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å</label>
        <input type="text" id="editArtist" />
      </div>
      <div class="form-group">
        <label>Spotify URL</label>
        <input type="url" id="editUrl" required />
      </div>
      <div style="display:flex;gap:12px;margin-top:16px;">
        <button type="button" class="btn-delete" id="btnDeleteItem" style="flex:1">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</button>
        <button type="submit" class="btn-primary" style="flex:1">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      </div>
    </form>
  </div>
</div>

<script src="https://sdk.scdn.co/spotify-player.js"></script>
<script type="module">
const CONFIG = {
  CLIENT_ID: 'c4699c1d0e98455fab4d9307b671f80c',
  REDIRECT_URI: window.location.origin + '/callback',
  SCOPES: 'streaming user-read-playback-state user-modify-playback-state user-read-currently-playing',
  STORAGE_KEY: 'skv-autodj-v4'
};

const DEFAULT_QUEUE = [
  { url: 'https://open.spotify.com/album/2SMf2fZr3arg0Vw63T5nzQ', type: 'album' },
  { url: 'https://open.spotify.com/album/4eYmRpMI7nUwnhEEPPwDyu', type: 'album' },
  { url: 'https://open.spotify.com/album/2ApRKWzy7nuVboZJIrttm5', type: 'album' },
  { url: 'https://open.spotify.com/playlist/6ao5XF0UXFW4YiBbaPVJf2', type: 'playlist' },
  { url: 'https://open.spotify.com/album/5IIM2OiO6Mm3OSYgrV4IXa', type: 'album' },
  { url: 'https://open.spotify.com/album/6QBs6v06fJ3LHMiX9weH79', type: 'album' },
  { url: 'https://open.spotify.com/album/2Kr2Dii8vxP3wcjQpdNaHA', type: 'album' },
  { url: 'https://open.spotify.com/playlist/2tVTJxWEvHrIjDroVO0vsk', type: 'playlist' }
];

let state = {
  token: null,
  refreshToken: null,
  deviceId: null,
  isPlaying: false,
  queue: [],
  currentIndex: 0,
  userId: null,
  sdkReady: false
};

const els = {
  alert: document.getElementById('alert'),
  sdkStatus: document.getElementById('sdkStatus'),
  btnConnect: document.getElementById('btnConnect'),
  currentTitle: document.getElementById('currentTitle'),
  currentArtist: document.getElementById('currentArtist'),
  currentIndex: document.getElementById('currentIndex'),
  btnOpen: document.getElementById('btnOpen'),
  btnPlay: document.getElementById('btnPlay'),
  btnPrev: document.getElementById('btnPrev'),
  btnNext: document.getElementById('btnNext'),
  playerControls: document.getElementById('playerControls'),
  btnPlayPause: document.getElementById('btnPlayPause'),
  btnPrevTrack: document.getElementById('btnPrevTrack'),
  btnNextTrack: document.getElementById('btnNextTrack'),
  volumeSlider: document.getElementById('volumeSlider'),
  queueList: document.getElementById('queueList'),
  addForm: document.getElementById('addForm'),
  editModal: document.getElementById('editModal'),
  editForm: document.getElementById('editForm'),
  btnDeleteItem: document.getElementById('btnDeleteItem')
};

function showAlert(msg, type = 'error') {
  els.alert.innerHTML = `<div class="alert alert-${type}">${msg}</div>`;
  setTimeout(() => els.alert.innerHTML = '', 5000);
}

function showSdkStatus(msg, type = 'loading') {
  els.sdkStatus.textContent = msg;
  els.sdkStatus.className = `sdk-status ${type}`;
  els.sdkStatus.classList.remove('hidden');
}

function saveState() {
  localStorage.setItem(CONFIG.STORAGE_KEY, JSON.stringify({
    token: state.token,
    refreshToken: state.refreshToken,
    queue: state.queue,
    currentIndex: state.currentIndex
  }));
}

function loadState() {
  const saved = localStorage.getItem(CONFIG.STORAGE_KEY);
  if (saved) {
    const data = JSON.parse(saved);
    state.token = data.token || null;
    state.refreshToken = data.refreshToken || null;
    state.queue = data.queue || [];
    state.currentIndex = data.currentIndex || 0;
  }
}

// Auth
async function generateCodeChallenge(verifier) {
  const encoder = new TextEncoder();
  const data = encoder.encode(verifier);
  const digest = await crypto.subtle.digest('SHA-256', data);
  return btoa(String.fromCharCode(...new Uint8Array(digest)))
    .replace(/\+/g, '-').replace(/\//g, '_').replace(/=/g, '');
}

async function connectSpotify() {
  const verifier = Array.from(crypto.getRandomValues(new Uint8Array(32)), b => b.toString(16).padStart(2, '0')).join('');
  localStorage.setItem('spotify_verifier', verifier);
  const challenge = await generateCodeChallenge(verifier);
  const params = new URLSearchParams({
    client_id: CONFIG.CLIENT_ID,
    response_type: 'code',
    redirect_uri: CONFIG.REDIRECT_URI,
    code_challenge_method: 'S256',
    code_challenge: challenge,
    scope: CONFIG.SCOPES
  });
  window.location.href = `https://accounts.spotify.com/authorize?${params}`;
}

async function exchangeCode(code) {
  const verifier = localStorage.getItem('spotify_verifier');
  if (!verifier) throw new Error('–ù–µ—Ç verifier –¥–ª—è PKCE');
  const res = await fetch('https://accounts.spotify.com/api/token', {
    method: 'POST',
    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
    body: new URLSearchParams({
      client_id: CONFIG.CLIENT_ID,
      grant_type: 'authorization_code',
      code,
      redirect_uri: CONFIG.REDIRECT_URI,
      code_verifier: verifier
    })
  });
  if (!res.ok) throw new Error(`Auth failed: ${res.status}`);
  const data = await res.json();
  state.token = data.access_token;
  state.refreshToken = data.refresh_token || null;
  localStorage.removeItem('spotify_verifier');
  saveState();

  // UI: –ø–æ–º–µ—á–∞–µ–º, —á—Ç–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–æ
  els.btnConnect.textContent = '‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–æ';
  els.btnConnect.disabled = true;
}

async function refreshTokens() {
  if (!state.refreshToken) return null;
  const res = await fetch('https://accounts.spotify.com/api/token', {
    method: 'POST',
    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
    body: new URLSearchParams({
      client_id: CONFIG.CLIENT_ID,
      grant_type: 'refresh_token',
      refresh_token: state.refreshToken
    })
  });
  if (!res.ok) return null;
  const data = await res.json();
  state.token = data.access_token;
  saveState();
  return state.token;
}

async function getValidToken() {
  if (state.token) return state.token;
  return await refreshTokens();
}

// SDK
let player = null;
let playerActivated = false;

window.onSpotifyWebPlaybackSDKReady = () => {
  state.sdkReady = true;
  console.log('‚úÖ Spotify SDK loaded');
  showSdkStatus('‚úÖ –ì–æ—Ç–æ–≤–æ –∫ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—é.', 'ready');
};

setTimeout(() => {
  if (!state.sdkReady) {
    console.warn('‚ö†Ô∏è Spotify SDK not loaded after 5s');
    showSdkStatus('‚ö†Ô∏è SDK –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª—Å—è. –ú–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å ¬´–û—Ç–∫—Ä—ã—Ç—å –≤ Spotify¬ª.', 'error');
  }
}, 5000);

async function initPlayerOnce() {
  if (player) return;
  if (!window.Spotify) {
    showSdkStatus('‚ùå SDK –Ω–µ –Ω–∞–π–¥–µ–Ω. –ò—Å–ø–æ–ª—å–∑—É–π ¬´–û—Ç–∫—Ä—ã—Ç—å –≤ Spotify¬ª.', 'error');
    return;
  }
  const token = await getValidToken();
  if (!token) {
    showAlert('–°–Ω–∞—á–∞–ª–∞ –ø–æ–¥–∫–ª—é—á–∏ Spotify —á–µ—Ä–µ–∑ –∫–Ω–æ–ø–∫—É ¬´–ü–æ–¥–∫–ª—é—á–∏—Ç—å¬ª.');
    return;
  }
  player = new Spotify.Player({
    name: 'SKV Auto DJ',
    getOAuthToken: async cb => cb(await getValidToken()),
    volume: 0.5
  });

  player.addListener('ready', ({ device_id }) => {
    state.deviceId = device_id;
    console.log('‚úÖ Device ready:', device_id);
    els.playerControls.classList.remove('hidden');
  });

  player.addListener('not_ready', () => {
    state.deviceId = null;
    console.log('‚ùå Device disconnected');
  });

  player.addListener('player_state_changed', s => {
    if (!s) return;
    state.isPlaying = !s.paused;
    els.btnPlayPause.textContent = state.isPlaying ? '‚è∏' : '‚ñ∂';
    els.btnPlay.textContent = state.isPlaying ? '‚è∏ –ü–∞—É–∑–∞' : '‚ñ∂ –ò–≥—Ä–∞—Ç—å –≤ —ç—Ç–æ–º –æ–∫–Ω–µ';
  });

  player.addListener('authentication_error', err => {
    console.error('Auth error:', err);
    showAlert('–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏. –ü–æ–¥–∫–ª—é—á–∏ Spotify –∑–∞–Ω–æ–≤–æ.');
  });

  player.addListener('account_error', err => {
    console.error('Account error:', err);
    showAlert('–ù—É–∂–µ–Ω Spotify Premium –¥–ª—è –ø—Ä–æ–∏–≥—Ä—ã–≤–∞–Ω–∏—è –≤ –±—Ä–∞—É–∑–µ—Ä–µ.');
  });

  const connected = await player.connect();
  if (!connected) {
    showSdkStatus('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å –ø–ª–µ–µ—Ä.', 'error');
  } else {
    console.log('‚úÖ Player initialized');
    els.btnPlayPause.onclick = () => player.togglePlay();
    els.btnPrevTrack.onclick = () => player.previousTrack();
    els.btnNextTrack.onclick = () => player.nextTrack();
    els.volumeSlider.oninput = (e) => player.setVolume(e.target.value / 100);
  }
}

async function activatePlayerAndPlay() {
  await initPlayerOnce();
  if (!player) {
    const item = state.queue[state.currentIndex];
    if (item) window.open(item.url, '_blank');
    return;
  }
  if (!playerActivated && player.activateElement) {
    try {
      await player.activateElement();
      playerActivated = true;
      console.log('üîì Audio element activated');
    } catch (e) {
      console.warn('activateElement failed:', e);
    }
  }
  await playCurrent();
}

// Helpers
function extractSpotifyId(url) {
  const clean = url.split('?')[0];
  const parts = clean.split('/');
  const id = parts[parts.length - 1];
  const type = clean.includes('album')
    ? 'album'
    : clean.includes('playlist')
      ? 'playlist'
      : clean.includes('track')
        ? 'track'
        : 'unknown';
  return { id, type };
}

function getSpotifyPlayPayload(item) {
  const { id, type } = extractSpotifyId(item.url);
  if (type === 'track') {
    return { uris: [`spotify:track:${id}`] };
  }
  if (type === 'album') {
    return { context_uri: `spotify:album:${id}` };
  }
  if (type === 'playlist') {
    return { context_uri: `spotify:playlist:${id}` };
  }
  return null;
}

async function playCurrent() {
  const item = state.queue[state.currentIndex];
  if (!item) { showAlert('–û—á–µ—Ä–µ–¥—å –ø—É—Å—Ç–∞'); return; }

  if (!state.sdkReady || !player) {
    showAlert('–ü–ª–µ–µ—Ä –Ω–µ –≥–æ—Ç–æ–≤. –û—Ç–∫—Ä—ã–≤–∞—é –≤ Spotify...', 'warning');
    window.open(item.url, '_blank');
    return;
  }

  const payload = getSpotifyPlayPayload(item);
  if (!payload) {
    window.open(item.url, '_blank');
    return;
  }

  const token = await getValidToken();
  if (!token) { showAlert('Spotify –Ω–µ –ø–æ–¥–∫–ª—é—á—ë–Ω'); return; }
  if (!state.deviceId) {
    showAlert('–£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –ø–ª–µ–µ—Ä–∞ –µ—â—ë –Ω–µ –≥–æ—Ç–æ–≤–æ. –ü–æ–¥–æ–∂–¥–∏ –ø–∞—Ä—É —Å–µ–∫—É–Ω–¥ –∏–ª–∏ –æ—Ç–∫—Ä–æ–π Spotify‚Äë–∫–ª–∏–µ–Ω—Ç.', 'warning');
    return;
  }

  try {
    await fetch('https://api.spotify.com/v1/me/player', {
      method: 'PUT',
      headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
      body: JSON.stringify({ device_ids: [state.deviceId], play: false })
    });

    const res = await fetch(`https://api.spotify.com/v1/me/player/play?device_id=${state.deviceId}`, {
      method: 'PUT',
      headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });

    if (!res.ok) {
      const err = await res.text();
      console.error('‚ùå Play failed:', res.status, err);
      showAlert(`–û—à–∏–±–∫–∞ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è (${res.status}). –û—Ç–∫—Ä—ã–≤–∞—é –≤ Spotify...`, 'warning');
      window.open(item.url, '_blank');
    }
  } catch (e) {
    console.error('‚ùå Error:', e);
    showAlert('–û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞. –û—Ç–∫—Ä—ã–≤–∞—é –≤ Spotify...', 'warning');
    window.open(item.url, '_blank');
  }
}

// Queue
async function loadQueue() {
  if (state.queue.length > 0) return;
  for (const item of DEFAULT_QUEUE) {
    try {
      const res = await fetch(`https://open.spotify.com/oembed?url=${encodeURIComponent(item.url)}&format=json`);
      if (res.ok) {
        const data = await res.json();
        const hasJazz = data.title.toLowerCase().includes('jazz') || data.title.toLowerCase().includes('blues');
        state.queue.push({
          title: data.title,
          artist: hasJazz ? 'Jazz music cafe' : 'Wordless Melodies Studio',
          url: item.url,
          type: item.type,
          color: hasJazz ? '#a78bfa' : '#38bdf8'
        });
      }
    } catch (e) {
      console.warn('Failed to load metadata:', item.url);
    }
  }
  saveState();
}

function render() {
  const item = state.queue[state.currentIndex];
  if (!item) return;
  els.currentTitle.textContent = item.title;
  els.currentArtist.textContent = item.artist;
  els.currentArtist.style.color = item.color || '#38bdf8';
  els.currentIndex.textContent = `${state.currentIndex + 1} / ${state.queue.length}`;
  els.queueList.innerHTML = state.queue.map((item, i) => `
    <div class="queue-item ${i === state.currentIndex ? 'active' : ''}" style="border-left-color: ${item.color}">
      <div class="queue-info" onclick="window.selectItem(${i})">
        <div class="queue-title"><span class="badge-type">${item.type.toUpperCase()}</span>${item.title}</div>
        <div class="queue-artist">${item.artist}</div>
      </div>
      <div class="queue-actions">
        <button class="btn-edit" onclick="window.editItem(${i})">‚úèÔ∏è</button>
      </div>
    </div>
  `).join('');
}

window.selectItem = (idx) => { state.currentIndex = idx; render(); saveState(); };

window.editItem = (idx) => {
  const item = state.queue[idx];
  document.getElementById('editIndex').value = idx;
  document.getElementById('editTitle').value = item.title;
  document.getElementById('editArtist').value = item.artist || '';
  document.getElementById('editUrl').value = item.url;
  els.editModal.classList.add('show');
};

els.editForm.onsubmit = (e) => {
  e.preventDefault();
  const idx = parseInt(document.getElementById('editIndex').value);
  state.queue[idx] = {
    ...state.queue[idx],
    title: document.getElementById('editTitle').value,
    artist: document.getElementById('editArtist').value,
    url: document.getElementById('editUrl').value
  };
  els.editModal.classList.remove('show');
  render();
  saveState();
  showAlert('‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ', 'success');
};

els.btnDeleteItem.onclick = () => {
  const idx = parseInt(document.getElementById('editIndex').value);
  if (confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç —Ä–µ–ª–∏–∑ –∏–∑ –æ—á–µ—Ä–µ–¥–∏?')) {
    state.queue.splice(idx, 1);
    if (state.currentIndex >= state.queue.length) state.currentIndex = Math.max(0, state.queue.length - 1);
    els.editModal.classList.remove('show');
    render();
    saveState();
    showAlert('üóëÔ∏è –£–¥–∞–ª–µ–Ω–æ', 'success');
  }
};

els.editModal.onclick = (e) => { if (e.target === els.editModal) els.editModal.classList.remove('show'); };

// UI handlers
els.addForm.onsubmit = (e) => {
  e.preventDefault();
  const title = document.getElementById('addTitle').value;
  const artist = document.getElementById('addArtist').value;
  const type = document.getElementById('addType').value;
  const url = document.getElementById('addUrl').value;
  const hasJazz = title.toLowerCase().includes('jazz') || title.toLowerCase().includes('blues');
  state.queue.push({
    title,
    artist: artist || (hasJazz ? 'Jazz music cafe' : 'Wordless Melodies Studio'),
    url,
    type,
    color: hasJazz ? '#a78bfa' : '#38bdf8'
  });
  els.addForm.reset();
  render();
  saveState();
  showAlert('‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ', 'success');
};

els.btnConnect.onclick = () => connectSpotify();
els.btnOpen.onclick = () => {
  const item = state.queue[state.currentIndex];
  if (item) window.open(item.url, '_blank');
};
els.btnPlay.onclick = () => activatePlayerAndPlay();

els.btnPrev.onclick = async () => {
  if (!state.queue.length) return;
  state.currentIndex = (state.currentIndex - 1 + state.queue.length) % state.queue.length;
  render();
  saveState();
  if (playerActivated) await playCurrent();
};
els.btnNext.onclick = async () => {
  if (!state.queue.length) return;
  state.currentIndex = (state.currentIndex + 1) % state.queue.length;
  render();
  saveState();
  if (playerActivated) await playCurrent();
};

// Init
(async () => {
  loadState();
  const code = new URLSearchParams(window.location.search).get('code');
  if (code) {
    try {
      await exchangeCode(code);
      window.history.replaceState({}, '', window.location.origin + window.location.pathname);
      showSdkStatus('üîÑ –¢–æ–∫–µ–Ω –ø–æ–ª—É—á–µ–Ω. –ñ–¥—ë–º SDK...', 'loading');
    } catch (e) {
      showAlert('–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏: ' + e.message);
    }
  } else if (state.token) {
    showSdkStatus('üîÑ –¢–æ–∫–µ–Ω –µ—Å—Ç—å. –ñ–¥—ë–º SDK...', 'loading');
    els.btnConnect.textContent = '‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–æ';
    els.btnConnect.disabled = true;
  }
  await loadQueue();
  render();
})();
</script>
</body>
</html>
