<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>SKV Auto DJ Player v3.2 - Fixed</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="theme-color" content="#0f172a" />
  <style>
    :root {
      --bg: #0f172a; --card: #111827; --accent: #38bdf8; --accent-soft: rgba(56,189,248,0.1);
      --text-main: #e5e7eb; --text-muted: #9ca3af; --danger: #f97373; --success: #22c55e;
      --spotify: #1DB954; --transition: all 0.16s ease;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: system-ui, -apple-system, sans-serif;
      background: radial-gradient(circle at top, #1e293b 0, #020617 55%, #000 100%);
      color: var(--text-main); min-height: 100vh; display: flex; align-items: center; justify-content: center; padding: 16px;
    }
    .app {
      width: 100%; max-width: 720px;
      background: linear-gradient(145deg, rgba(15,23,42,0.96), rgba(15,23,42,0.9));
      border-radius: 18px; border: 1px solid rgba(148,163,184,0.35);
      box-shadow: 0 24px 60px rgba(15,23,42,0.75), 0 0 0 1px rgba(15,23,42,0.8);
      padding: 20px 22px 18px; backdrop-filter: blur(22px);
    }
    @media (min-width: 640px) { .app { padding: 24px 26px 22px; } }
    .app-header { display: flex; justify-content: space-between; gap: 16px; align-items: flex-start; margin-bottom: 18px; }
    .title-block h1 { font-size: 1.3rem; margin: 0 0 6px; letter-spacing: 0.03em; }
    .title-block p { margin: 0; font-size: 0.9rem; color: var(--text-muted); }
    .tag {
      padding: 4px 10px; border-radius: 999px; font-size: 0.75rem;
      border: 1px solid rgba(148,163,184,0.55); color: #e5e7eb;
      background: rgba(15,23,42,0.85); display: inline-flex; align-items: center; gap: 6px;
    }
    .tag-dot { width: 7px; height: 7px; border-radius: 999px; background: var(--success); box-shadow: 0 0 0 6px rgba(34,197,94,0.25); }
    .tag-dot.offline { background: var(--danger); box-shadow: 0 0 0 6px rgba(249,115,115,0.25); }
    .spotify-connect {
      background: linear-gradient(135deg, var(--spotify), #1ed760);
      color: #000; border: none; padding: 10px 20px; border-radius: 999px;
      font-weight: 700; cursor: pointer; display: inline-flex; align-items: center; gap: 8px;
      transition: var(--transition); box-shadow: 0 4px 15px rgba(29,185,84,0.4);
    }
    .spotify-connect:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(29,185,84,0.6); }
    .spotify-connect.connected { background: linear-gradient(135deg, #059669, #10b981); color: #fff; }
    .current-card {
      margin-bottom: 14px; border-radius: 14px; padding: 14px 14px 12px;
      background: radial-gradient(circle at top left, rgba(56,189,248,0.22), transparent 60%), linear-gradient(145deg, rgba(15,23,42,0.9), rgba(15,23,42,0.96));
      border: 1px solid rgba(148,163,184,0.5); position: relative; overflow: hidden;
    }
    .current-card::before {
      content: ""; position: absolute; inset: -60%;
      background: radial-gradient(circle at 0 0, rgba(56,189,248,0.12), transparent 55%);
      opacity: 0.8; pointer-events: none;
    }
    .current-inner { position: relative; display: flex; flex-direction: column; gap: 10px; z-index: 1; }
    .current-label { font-size: 0.8rem; text-transform: uppercase; letter-spacing: 0.16em; color: rgba(148,163,184,0.95); }
    .current-title { font-size: 1.05rem; margin: 0; word-break: break-word; }
    .current-type { font-size: 0.8rem; text-transform: uppercase; letter-spacing: 0.2em; color: rgba(148,163,184,0.9); }
    .current-artist {
      font-size: 0.9rem; cursor: pointer;
      transition: var(--transition); display: inline-flex; align-items: center; gap: 4px;
    }
    .current-artist:hover { filter: brightness(1.2); text-decoration: underline; }
    .current-index { font-size: 0.85rem; color: var(--text-muted); }
    .controls { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 10px; }
    button { border: none; cursor: pointer; font: inherit; }
    .btn-main, .btn-secondary, .btn-ghost, .btn-danger, .btn-edit, .btn-spotify {
      border-radius: 999px; padding: 8px 14px; font-size: 0.9rem;
      display: inline-flex; align-items: center; gap: 8px; transition: var(--transition); white-space: nowrap;
    }
    .btn-main {
      background: linear-gradient(135deg, var(--success), #16a34a); color: #0b1120; font-weight: 600;
      box-shadow: 0 0 0 1px rgba(22,163,74,0.6), 0 14px 35px rgba(22,163,74,0.45);
    }
    .btn-main:hover { filter: brightness(1.06); transform: translateY(-0.5px); }
    .btn-secondary {
      background: rgba(15,23,42,0.96); border: 1px solid rgba(148,163,184,0.6); color: var(--text-main);
    }
    .btn-secondary:hover { border-color: var(--accent); background: radial-gradient(circle at top, rgba(56,189,248,0.14), rgba(15,23,42,0.98)); transform: translateY(-0.5px); }
    .btn-ghost { background: transparent; color: rgba(148,163,184,0.9); padding-inline: 10px; }
    .btn-ghost:hover { color: var(--accent); }
    .btn-danger {
      background: rgba(249,115,115,0.15); border: 1px solid rgba(249,115,115,0.5); color: var(--danger);
    }
    .btn-danger:hover { background: rgba(249,115,115,0.25); border-color: var(--danger); }
    .btn-edit {
      background: rgba(56,189,248,0.15); border: 1px solid rgba(56,189,248,0.5); color: var(--accent);
    }
    .btn-edit:hover { background: rgba(56,189,248,0.25); border-color: var(--accent); }
    .btn-spotify { background: var(--spotify); color: #000; font-weight: 600; }
    .btn-spotify:hover { filter: brightness(1.1); transform: translateY(-0.5px); }
    .btn-icon { font-size: 0.95rem; }
    .btn-small { padding: 4px 8px; font-size: 0.75rem; }
    .playback-controls {
      display: flex; align-items: center; gap: 12px; margin-top: 10px;
      padding: 10px; background: rgba(0,0,0,0.3); border-radius: 12px;
    }
    .playback-btn {
      width: 40px; height: 40px; border-radius: 50%;
      background: var(--text-main); color: var(--bg);
      display: flex; align-items: center; justify-content: center;
      font-size: 1.2rem; transition: var(--transition);
    }
    .playback-btn:hover { transform: scale(1.1); }
    .playback-btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
    .volume-control { display: flex; align-items: center; gap: 8px; flex: 1; }
    .volume-slider {
      flex: 1; height: 4px; border-radius: 2px;
      background: rgba(148,163,184,0.3); appearance: none; cursor: pointer;
    }
    .volume-slider::-webkit-slider-thumb {
      appearance: none; width: 14px; height: 14px; border-radius: 50%;
      background: var(--text-main); cursor: pointer;
    }
    .timeline-row { display: flex; justify-content: space-between; align-items: center; gap: 12px; margin-top: 4px; }
    .timeline { flex: 1; height: 4px; background: rgba(30,64,175,0.6); border-radius: 999px; overflow: hidden; }
    .timeline-fill { height: 100%; width: 0%; background: linear-gradient(90deg, var(--success), var(--accent)); transition: width 0.25s linear; }
    .timer-label { font-size: 0.8rem; color: var(--text-muted); min-width: 112px; text-align: right; }
    .list {
      margin-top: 14px; border-radius: 14px; background: rgba(15,23,42,0.9);
      border: 1px dashed rgba(148,163,184,0.45); padding: 10px 12px; max-height: 220px; overflow-y: auto;
    }
    .list-title { font-size: 0.8rem; text-transform: uppercase; letter-spacing: 0.16em; color: rgba(148,163,184,0.95); margin-bottom: 6px; }
    .list-item {
      padding: 7px 8px; border-radius: 10px; display: flex; align-items: center; gap: 8px;
      font-size: 0.86rem; cursor: pointer; transition: var(--transition);
    }
    .list-item:hover { background: rgba(30,64,175,0.7); transform: translateY(-0.5px); }
    .list-item.active { background: rgba(37,99,235,0.9); color: #e5e7eb; }
    .badge {
      font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.18em; padding: 2px 8px;
      border-radius: 999px; background: rgba(15,23,42,0.96); border: 1px solid rgba(148,163,184,0.6);
    }
    .badge.playlist { border-color: rgba(56,189,248,0.9); color: #7dd3fc; }
    .badge.album { border-color: rgba(94,234,212,0.8); color: #a5f3fc; }
    .index-dot { width: 7px; height: 7px; border-radius: 999px; background: rgba(148,163,184,0.75); }
    .list-item.active .index-dot { background: var(--success); }
    .list-content { flex: 1; min-width: 0; }
    .list-title-text { font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .list-artist { 
      font-size: 0.75rem; cursor: pointer; transition: var(--transition); margin-top: 2px;
    }
    .list-artist:hover { filter: brightness(1.2); text-decoration: underline; }
    .list-actions { display: flex; gap: 4px; margin-left: 8px; }
    .list-actions button { padding: 3px 6px; font-size: 0.7rem; opacity: 0; transition: var(--transition); }
    .list-item:hover .list-actions button { opacity: 1; }
    .footer { margin-top: 10px; display: flex; justify-content: space-between; gap: 10px; align-items: center; font-size: 0.78rem; color: var(--text-muted); }
    .hint { color: rgba(148,163,184,0.9); }
    .danger { color: var(--danger); }
    .hidden { display: none !important; }
    .loading { opacity: 0.6; pointer-events: none; }
    .add-release {
      margin-top: 12px; padding: 10px; border-radius: 12px;
      background: rgba(30,41,59,0.6); border: 1px solid rgba(148,163,184,0.3);
    }
    .add-release input, .add-release select {
      width: 100%; padding: 8px 10px; margin: 4px 0; border-radius: 8px;
      border: 1px solid rgba(148,163,184,0.4); background: rgba(15,23,42,0.8); color: var(--text-main);
      font-size: 0.9rem;
    }
    .add-release input:focus, .add-release select:focus {
      outline: none; border-color: var(--accent); box-shadow: 0 0 0 2px var(--accent-soft);
    }
    .version {
      position: fixed; bottom: 8px; right: 8px;
      font-size: 0.7rem; color: rgba(148,163,184,0.5); pointer-events: none;
    }
    .sync-indicator {
      position: fixed; top: 16px; left: 50%; transform: translateX(-50%);
      background: rgba(34,197,94,0.9); color: #0b1120;
      padding: 8px 16px; border-radius: 999px; font-size: 0.85rem; font-weight: 600;
      box-shadow: 0 4px 12px rgba(34,197,94,0.4); z-index: 1000; display: none;
    }
    .sync-indicator.show { display: block; animation: slideDown 0.3s ease; }
    @keyframes slideDown {
      from { transform: translate(-50%, -100%); opacity: 0; }
      to { transform: translate(-50%, 0); opacity: 1; }
    }
    .modal-overlay {
      position: fixed; inset: 0; background: rgba(0,0,0,0.75);
      backdrop-filter: blur(4px); z-index: 2000;
      display: none; align-items: center; justify-content: center; padding: 16px;
    }
    .modal-overlay.show { display: flex; animation: fadeIn 0.2s ease; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    .modal {
      background: linear-gradient(145deg, rgba(15,23,42,0.98), rgba(15,23,42,0.95));
      border: 1px solid rgba(148,163,184,0.35); border-radius: 16px;
      padding: 20px; width: 100%; max-width: 480px;
      box-shadow: 0 24px 60px rgba(0,0,0,0.75);
    }
    .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
    .modal-header h2 { font-size: 1.1rem; margin: 0; }
    .modal-close {
      background: transparent; border: none; color: var(--text-muted);
      font-size: 1.5rem; cursor: pointer; padding: 4px;
    }
    .modal-close:hover { color: var(--text-main); }
    .modal-form { display: flex; flex-direction: column; gap: 12px; }
    .modal-form label { font-size: 0.8rem; color: var(--text-muted); margin-bottom: 4px; }
    .modal-form input, .modal-form select {
      width: 100%; padding: 10px 12px; border-radius: 8px;
      border: 1px solid rgba(148,163,184,0.4); background: rgba(15,23,42,0.8);
      color: var(--text-main); font-size: 0.9rem;
    }
    .modal-form input:focus, .modal-form select:focus {
      outline: none; border-color: var(--accent); box-shadow: 0 0 0 2px var(--accent-soft);
    }
    .modal-actions { display: flex; gap: 8px; margin-top: 8px; }
    .modal-actions button { flex: 1; }
    .color-indicator {
      display: inline-block; width: 16px; height: 16px; border-radius: 4px;
      margin-left: 8px; vertical-align: middle; border: 2px solid rgba(148,163,184,0.5);
    }
    .now-playing {
      display: inline-flex; align-items: center; gap: 6px;
      padding: 4px 10px; background: rgba(29,185,84,0.2);
      border: 1px solid rgba(29,185,84,0.5); border-radius: 999px;
      font-size: 0.75rem; color: var(--spotify); margin-left: 8px;
    }
    .now-playing-dot {
      width: 6px; height: 6px; border-radius: 50%;
      background: var(--spotify); animation: pulse 1s infinite;
    }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.4; } }
    .callback-message {
      text-align: center; padding: 60px 20px;
    }
    .callback-message h1 { font-size: 2rem; margin-bottom: 16px; color: var(--success); }
    .callback-message p { color: var(--text-muted); margin-bottom: 24px; }
    .callback-message .btn-main { display: inline-flex; }
  </style>
</head>
<body>
<div class="sync-indicator" id="syncIndicator">üîÑ –ó–∞–≥—Ä—É–∑–∫–∞...</div>

<div id="callbackPage" class="app hidden">
  <div class="callback-message">
    <h1>üéµ Spotify –ø–æ–¥–∫–ª—é—á—ë–Ω!</h1>
    <p>–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –ø—Ä–æ—à–ª–∞ —É—Å–ø–µ—à–Ω–æ. –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ...</p>
    <button class="btn-main" onclick="window.location.href='/'">‚Üê –í–µ—Ä–Ω—É—Ç—å—Å—è –≤ –ø–ª–µ–µ—Ä</button>
  </div>
</div>

<div class="modal-overlay" id="editModal">
  <div class="modal">
    <div class="modal-header">
      <h2>‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ä–µ–ª–∏–∑</h2>
      <button class="modal-close" id="modalClose">&times;</button>
    </div>
    <form class="modal-form" id="editForm">
      <input type="hidden" id="editIndex" />
      <div><label>–ù–∞–∑–≤–∞–Ω–∏–µ</label><input type="text" id="editTitle" required /></div>
      <div><label>–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å <span class="color-indicator" id="editColorIndicator"></span></label><input type="text" id="editArtist" placeholder="–ù–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ" /></div>
      <div><label>–¶–≤–µ—Ç –∞—Ä—Ç–∏—Å—Ç–∞</label><input type="color" id="editColor" value="#38bdf8" style="height:40px;padding:2px;" /></div>
      <div><label>–¢–∏–ø</label><select id="editType"><option value="album">–ê–ª—å–±–æ–º</option><option value="playlist">–ü–ª–µ–π–ª–∏—Å—Ç</option></select></div>
      <div><label>Spotify URL</label><input type="url" id="editUrl" required /></div>
      <div class="modal-actions">
        <button type="button" class="btn-danger" id="btnDeleteFromModal">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</button>
        <button type="submit" class="btn-main">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      </div>
    </form>
  </div>
</div>

<div class="app" id="mainApp" role="application" aria-label="SKV Auto DJ Player">
  <header class="app-header">
    <div class="title-block">
      <h1>SKV Auto DJ ¬∑ Spotify</h1>
      <p>–ü–æ –æ—á–µ—Ä–µ–¥–∏ –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç —Ç–≤–æ–∏ –∞–ª—å–±–æ–º—ã –∏ –ø–ª–µ–π–ª–∏—Å—Ç—ã. –û–¥–∏–Ω –∫–ª–∏–∫ ‚Äì –æ–¥–∏–Ω –ø–µ—Ä–µ—Ö–æ–¥.</p>
    </div>
    <div style="display:flex;gap:8px;align-items:center;">
      <button class="spotify-connect" id="btnConnectSpotify">
        <span>üéµ</span><span id="connectSpotifyText">–ü–æ–¥–∫–ª—é—á–∏—Ç—å Spotify</span>
      </button>
      <div class="tag" id="statusTag">
        <span class="tag-dot" id="statusDot"></span>
        <span id="statusText">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
      </div>
    </div>
  </header>

  <main>
    <section class="current-card" id="currentCard" aria-live="polite">
      <div class="current-inner">
        <div class="current-label">–¢–µ–∫—É—â–∏–π —Ä–µ–ª–∏–∑</div>
        <h2 class="current-title" id="currentTitle">–ó–∞–≥—Ä—É–∑–∫–∞...</h2>
        <div class="current-type" id="currentType">‚Äî</div>
        <div class="current-artist" id="currentArtist">‚Äî</div>
        <div class="current-index" id="currentIndex">0 / 0</div>
        <div class="controls">
          <button class="btn-main" id="btnOpen">
            <span class="btn-icon">‚ñ∂</span><span>–û—Ç–∫—Ä—ã—Ç—å –≤ Spotify</span>
          </button>
          <button class="btn-spotify hidden" id="btnPlayPause">
            <span class="btn-icon" id="playPauseIcon">‚ñ∂</span><span id="playPauseText">–ò–≥—Ä–∞—Ç—å</span>
          </button>
          <button class="btn-secondary" id="btnPrev">‚ü®‚ü® –ù–∞–∑–∞–¥</button>
          <button class="btn-secondary" id="btnNext">‚ü©‚ü© –í–ø–µ—Ä—ë–¥</button>
          <button class="btn-ghost" id="btnToggleTimer">‚è± <span id="timerBtnText">–¢–∞–π–º–µ—Ä –≤—ã–∫–ª.</span></button>
        </div>
        <div class="playback-controls hidden" id="playbackControls">
          <button class="playback-btn" id="btnPrevTrack">‚èÆ</button>
          <button class="playback-btn" id="btnPlayPauseTrack">‚ñ∂</button>
          <button class="playback-btn" id="btnNextTrack">‚è≠</button>
          <div class="volume-control">
            <span>üîà</span>
            <input type="range" class="volume-slider" id="volumeSlider" min="0" max="100" value="50" />
            <span>üîä</span>
          </div>
        </div>
        <div class="timeline-row">
          <div class="timeline"><div class="timeline-fill" id="timelineFill"></div></div>
          <div class="timer-label" id="timerLabel">–¢–∞–π–º–µ—Ä –≤—ã–∫–ª—é—á–µ–Ω</div>
        </div>
      </div>
    </section>

    <section class="list" id="list">
      <div class="list-title">–û—á–µ—Ä–µ–¥—å —Ä–µ–ª–∏–∑–æ–≤</div>
    </section>

    <details class="add-release">
      <summary style="cursor:pointer;font-size:0.9rem;margin-bottom:8px;color:var(--accent)">+ –î–æ–±–∞–≤–∏—Ç—å —Ä–µ–ª–∏–∑</summary>
      <form id="addReleaseForm">
        <input type="text" id="newTitle" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ" required />
        <input type="text" id="newArtist" placeholder="–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)" />
        <input type="color" id="newColor" value="#38bdf8" style="width:100%;height:36px;padding:2px;border:none;border-radius:6px;cursor:pointer;" />
        <select id="newType">
          <option value="album">–ê–ª—å–±–æ–º</option>
          <option value="playlist">–ü–ª–µ–π–ª–∏—Å—Ç</option>
        </select>
        <input type="url" id="newUrl" placeholder="https://open.spotify.com/..." required pattern="https://open\.spotify\.com/.*" />
        <button type="submit" class="btn-secondary btn-small" style="width:100%;margin-top:6px">–î–æ–±–∞–≤–∏—Ç—å –≤ –æ—á–µ—Ä–µ–¥—å</button>
      </form>
    </details>
  </main>

  <footer class="footer">
    <div class="hint">üí° ‚Üê ‚Üí –Ω–∞–≤–∏–≥–∞—Ü–∏—è, Space –æ—Ç–∫—Ä—ã—Ç—å, T —Ç–∞–π–º–µ—Ä</div>
    <div class="danger">–ù–µ –¥–ª—è –Ω–∞–∫—Ä—É—Ç–∫–∏, —Ç–æ–ª—å–∫–æ –¥–ª—è –∫–æ–º—Ñ–æ—Ä—Ç–∞.</div>
  </footer>
  
  <div class="version">v3.2-Fixed</div>
</div>

<script src="https://sdk.scdn.co/spotify-player.js"></script>
<script type="module">
const APP_VERSION = '3.2-Fixed';
const SPOTIFY_CLIENT_ID = 'c4699c1d0e98455fab4d9307b671f80c';
const REDIRECT_URI = window.location.origin + '/callback';
const SCOPES = 'streaming user-read-playback-state user-modify-playback-state user-read-currently-playing';

const CONFIG = {
  TIMER_MINUTES: 60,
  STORAGE_KEY: 'skv-autodj-state-v9',
  DEFAULT_RELEASES: [
    { url: 'https://open.spotify.com/album/2SMf2fZr3arg0Vw63T5nzQ', type: 'album' },
    { url: 'https://open.spotify.com/album/4eYmRpMI7nUwnhEEPPwDyu', type: 'album' },
    { url: 'https://open.spotify.com/album/2ApRKWzy7nuVboZJIrttm5', type: 'album' },
    { url: 'https://open.spotify.com/playlist/6ao5XF0UXFW4YiBbaPVJf2', type: 'playlist' },
    { url: 'https://open.spotify.com/album/5IIM2OiO6Mm3OSYgrV4IXa', type: 'album' },
    { url: 'https://open.spotify.com/album/6QBs6v06fJ3LHMiX9weH79', type: 'album' },
    { url: 'https://open.spotify.com/album/2Kr2Dii8vxP3wcjQpdNaHA', type: 'album' },
    { url: 'https://open.spotify.com/playlist/2tVTJxWEvHrIjDroVO0vsk', type: 'playlist' }
  ]
};

const ARTIST_COLORS = { 'jazz music cafe': '#a78bfa', 'wordless melodies studio': '#38bdf8' };
const DEFAULT_COLOR = '#94a3b8';

const Storage = {
  load() { try { const r = localStorage.getItem(CONFIG.STORAGE_KEY); return r ? JSON.parse(r) : null; } catch { return null; } },
  save(s) { try { s.appVersion = APP_VERSION; localStorage.setItem(CONFIG.STORAGE_KEY, JSON.stringify(s)); } catch(e) { console.warn('Save failed:', e); } },
  get(key) { return localStorage.getItem(key); },
  set(key, val) { localStorage.setItem(key, val); },
  remove(key) { localStorage.removeItem(key); }
};

const SpotifyAuth = {
  accessToken: null, refreshToken: null, expiresAt: 0,
  async connect() {
    const codeVerifier = this.generateCodeVerifier();
    const codeChallenge = await this.generateCodeChallenge(codeVerifier);
    Storage.set('spotify_code_verifier', codeVerifier);
    const authUrl = new URL('https://accounts.spotify.com/authorize');
    authUrl.searchParams.set('client_id', SPOTIFY_CLIENT_ID);
    authUrl.searchParams.set('redirect_uri', REDIRECT_URI);
    authUrl.searchParams.set('response_type', 'code');
    authUrl.searchParams.set('code_challenge_method', 'S256');
    authUrl.searchParams.set('code_challenge', codeChallenge);
    authUrl.searchParams.set('scope', SCOPES);
    window.location.href = authUrl.toString();
  },
  async getToken(code) {
    const codeVerifier = Storage.get('spotify_code_verifier');
    const response = await fetch('https://accounts.spotify.com/api/token', {
      method: 'POST',
      headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
      body: new URLSearchParams({
        client_id: SPOTIFY_CLIENT_ID, grant_type: 'authorization_code',
        code: code, redirect_uri: REDIRECT_URI, code_verifier: codeVerifier
      })
    });
    const data = await response.json();
    this.accessToken = data.access_token;
    this.refreshToken = data.refresh_token;
    this.expiresAt = Date.now() + (data.expires_in * 1000);
    Storage.set('spotify_access_token', this.accessToken);
    Storage.set('spotify_refresh_token', this.refreshToken);
    Storage.set('spotify_expires_at', this.expiresAt.toString());
    return this.accessToken;
  },
  async refreshAccessToken() {
    const refreshToken = Storage.get('spotify_refresh_token');
    if (!refreshToken) return null;
    const response = await fetch('https://accounts.spotify.com/api/token', {
      method: 'POST',
      headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
      body: new URLSearchParams({
        client_id: SPOTIFY_CLIENT_ID, grant_type: 'refresh_token', refresh_token: refreshToken
      })
    });
    const data = await response.json();
    this.accessToken = data.access_token;
    this.expiresAt = Date.now() + (data.expires_in * 1000);
    Storage.set('spotify_access_token', this.accessToken);
    Storage.set('spotify_expires_at', this.expiresAt.toString());
    return this.accessToken;
  },
  async getValidToken() {
    if (this.accessToken && Date.now() < this.expiresAt - 60000) return this.accessToken;
    const stored = Storage.get('spotify_access_token');
    const expires = parseInt(Storage.get('spotify_expires_at') || '0');
    if (stored && Date.now() < expires - 60000) { this.accessToken = stored; return stored; }
    if (expires && Date.now() < expires + (30 * 24 * 60 * 60 * 1000)) return await this.refreshAccessToken();
    return null;
  },
  generateCodeVerifier() {
    const array = new Uint8Array(32);
    crypto.getRandomValues(array);
    return Array.from(array, b => b.toString(16).padStart(2, '0')).join('');
  },
  async generateCodeChallenge(verifier) {
    const encoder = new TextEncoder();
    const data = encoder.encode(verifier);
    const digest = await crypto.subtle.digest('SHA-256', data);
    return btoa(String.fromCharCode(...new Uint8Array(digest))).replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
  },
  disconnect() {
    this.accessToken = null; this.refreshToken = null; this.expiresAt = 0;
    Storage.remove('spotify_access_token'); Storage.remove('spotify_refresh_token');
    Storage.remove('spotify_expires_at'); Storage.remove('spotify_code_verifier');
  },
  isConnected() { return !!Storage.get('spotify_refresh_token'); }
};

const SpotifyPlayer = {
  player: null, deviceId: null, isPlaying: false,
  async init(token) {
    if (!window.Spotify) { console.error('‚ùå Spotify SDK not loaded'); return false; }
    this.player = new window.Spotify.Player({
      name: 'SKV Auto DJ',
      getOAuthToken: async cb => { const token = await SpotifyAuth.getValidToken(); cb(token); },
      volume: 0.5
    });
    this.player.addListener('ready', ({ device_id }) => { 
      this.deviceId = device_id; 
      console.log('‚úÖ Device ID:', device_id);
    });
    this.player.addListener('not_ready', () => { this.deviceId = null; });
    this.player.addListener('player_state_changed', state => { 
      if (!state) return;
      this.isPlaying = !state.paused;
      if (App.instance) App.instance.updatePlaybackUI();
    });
    await this.player.connect();
    return true;
  },
  async play(uri) {
    if (!this.deviceId) { console.error('‚ùå No device'); return false; }
    const token = await SpotifyAuth.getValidToken();
    const response = await fetch(`https://api.spotify.com/v1/me/player/play?device_id=${this.deviceId}`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
      body: JSON.stringify({ uris: [uri] })
    });
    return response.ok;
  },
  async togglePlay() {
    const token = await SpotifyAuth.getValidToken();
    await fetch('https://api.spotify.com/v1/me/player/playback', {
      method: 'PUT', headers: { 'Authorization': `Bearer ${token}` }
    });
  },
  async setVolume(volume) {
    const token = await SpotifyAuth.getValidToken();
    await fetch(`https://api.spotify.com/v1/me/player/volume?volume_percent=${volume}`, {
      method: 'PUT', headers: { 'Authorization': `Bearer ${token}` }
    });
  },
  async nextTrack() {
    const token = await SpotifyAuth.getValidToken();
    await fetch('https://api.spotify.com/v1/me/player/next', {
      method: 'POST', headers: { 'Authorization': `Bearer ${token}` }
    });
  },
  async prevTrack() {
    const token = await SpotifyAuth.getValidToken();
    await fetch('https://api.spotify.com/v1/me/player/previous', {
      method: 'POST', headers: { 'Authorization': `Bearer ${token}` }
    });
  },
  disconnect() { if (this.player) { this.player.disconnect(); this.player = null; } this.deviceId = null; }
};

const Utils = {
  cleanUrl: (url) => url?.trim().split('?')[0] || '',
  formatTime: (ms) => { const s = Math.floor(ms/1000); return `${Math.floor(s/60)}:${(s%60).toString().padStart(2,'0')}`; },
  debounce: (fn, d) => { let t; return (...a) => { clearTimeout(t); t = setTimeout(() => fn.apply(this,a), d); }; },
  openUrl: (url, newTab = true) => { const clean = Utils.cleanUrl(url); if (!clean) return; if (newTab) window.open(clean, '_blank', 'noopener,noreferrer'); else window.location.href = clean; },
  getArtistForTitle(title) {
    const hasJazzOrBlues = title.toLowerCase().includes('jazz') || title.toLowerCase().includes('blues');
    if (hasJazzOrBlues) { return { artist: 'Jazz music cafe', artistUrl: 'https://open.spotify.com/artist/3UcCq23JmhAPyouBTMCs6k', accentColor: '#a78bfa' }; }
    else { return { artist: 'Wordless Melodies Studio', artistUrl: 'https://open.spotify.com/artist/420qn4LMRpWuHmcsuuYLRF', accentColor: '#38bdf8' }; }
  },
  getColorForArtist(artistName) {
    if (!artistName) return DEFAULT_COLOR;
    const lower = artistName.toLowerCase().trim();
    for (const [key, color] of Object.entries(ARTIST_COLORS)) { if (lower.includes(key)) return color; }
    return DEFAULT_COLOR;
  },
  updateColorFromArtist(artistInput, colorInput, indicatorEl = null) {
    const artistName = artistInput.value.trim();
    const color = Utils.getColorForArtist(artistName);
    colorInput.value = color;
    if (indicatorEl) { indicatorEl.style.backgroundColor = color; indicatorEl.style.borderColor = color; }
  },
  getSpotifyUri(url) {
    const clean = Utils.cleanUrl(url);
    const match = clean.match(/(?:album|playlist|track)\/([a-zA-Z0-9]+)/);
    if (match) { const type = clean.includes('album') ? 'album' : clean.includes('playlist') ? 'playlist' : 'track'; return `spotify:${type}:${match[1]}`; }
    return null;
  },
  async fetchSpotifyMetadata(url) {
    try {
      const cleanUrl = Utils.cleanUrl(url);
      const response = await fetch(`https://open.spotify.com/oembed?url=${encodeURIComponent(cleanUrl)}&format=json`);
      if (response.ok) { const data = await response.json(); return { title: data.title || null, author: data.author_name || null }; }
    } catch (e) { console.warn('Failed to fetch meta', e); }
    return null;
  }
};

class ReleaseQueue {
  constructor(items) { this.items = items.map(i => ({...i, url: i.url?.trim(), artistUrl: i.artistUrl?.trim(), artist: i.artist || 'Wordless Melodies Studio', accentColor: i.accentColor || '#38bdf8' })); }
  get length() { return this.items.length; }
  get(i) { return this.items[i] || null; }
  add(data) { this.items.push({ title: data.title, artist: data.artist || 'Wordless Melodies Studio', artistUrl: data.artistUrl || '', accentColor: data.accentColor || '#38bdf8', type: data.type, url: data.url.trim() }); return this.items.length - 1; }
  update(index, data) { if (index >= 0 && index < this.items.length) { this.items[index] = { ...this.items[index], ...data }; return true; } return false; }
  remove(index) { if (index >= 0 && index < this.items.length) { return this.items.splice(index, 1)[0]; } return null; }
}

class SessionTimer {
  constructor(mins, onUpdate, onComplete) {
    this.totalMs = mins * 60 * 1000; this.onUpdate = onUpdate; this.onComplete = onComplete;
    this.startTs = null; this.interval = null; this.enabled = false;
  }
  start() { if (this.enabled) return; this.enabled = true; this.startTs = Date.now(); this._tick(); this.interval = setInterval(() => this._tick(), 1000); }
  stop() { this.enabled = false; if (this.interval) clearInterval(this.interval); this.interval = null; }
  reset() { this.startTs = Date.now(); if (this.enabled) this._tick(); }
  _tick() {
    if (!this.enabled || !this.startTs) return;
    const elapsed = Date.now() - this.startTs;
    const progress = Math.min(elapsed / this.totalMs, 1);
    const remaining = Math.max(this.totalMs - elapsed, 0);
    this.onUpdate?.({progress, remaining});
    if (elapsed >= this.totalMs) { this.onComplete?.(); this.stop(); }
  }
}

class App {
  static instance = null;
  constructor() {
    App.instance = this;
    this.queue = null; this.idx = 0; this.timer = null; this.timerOn = false; this.spotifyConnected = false;
    this.els = {
      card: document.getElementById('currentCard'), title: document.getElementById('currentTitle'), type: document.getElementById('currentType'),
      artist: document.getElementById('currentArtist'), index: document.getElementById('currentIndex'),
      list: document.getElementById('list'), timeline: document.getElementById('timelineFill'),
      timerLabel: document.getElementById('timerLabel'), timerBtn: document.getElementById('btnToggleTimer'),
      timerBtnText: document.getElementById('timerBtnText'), btnOpen: document.getElementById('btnOpen'),
      btnPrev: document.getElementById('btnPrev'), btnNext: document.getElementById('btnNext'),
      form: document.getElementById('addReleaseForm'), status: document.getElementById('statusTag'),
      statusText: document.getElementById('statusText'), statusDot: document.getElementById('statusDot'),
      syncIndicator: document.getElementById('syncIndicator'),
      editModal: document.getElementById('editModal'), editForm: document.getElementById('editForm'),
      modalClose: document.getElementById('modalClose'), editIndex: document.getElementById('editIndex'),
      editTitle: document.getElementById('editTitle'), editArtist: document.getElementById('editArtist'),
      editColor: document.getElementById('editColor'), editType: document.getElementById('editType'),
      editUrl: document.getElementById('editUrl'), btnDeleteFromModal: document.getElementById('btnDeleteFromModal'),
      editColorIndicator: document.getElementById('editColorIndicator'),
      newArtist: document.getElementById('newArtist'), newColor: document.getElementById('newColor'),
      btnConnectSpotify: document.getElementById('btnConnectSpotify'),
      connectSpotifyText: document.getElementById('connectSpotifyText'),
      btnPlayPause: document.getElementById('btnPlayPause'),
      playPauseIcon: document.getElementById('playPauseIcon'),
      playPauseText: document.getElementById('playPauseText'),
      playbackControls: document.getElementById('playbackControls'),
      btnPlayPauseTrack: document.getElementById('btnPlayPauseTrack'),
      btnPrevTrack: document.getElementById('btnPrevTrack'),
      btnNextTrack: document.getElementById('btnNextTrack'),
      volumeSlider: document.getElementById('volumeSlider'),
      nowPlayingIndicator: document.getElementById('nowPlayingIndicator')
    };
    this.init();
  }
  
  async init() {
    const saved = Storage.load();
    if (saved && saved.releases) { 
      this.queue = new ReleaseQueue(saved.releases); 
      this.idx = saved.currentIndex ?? 0; 
    } else { 
      await this.fetchAllMetadata(); 
    }
    this.spotifyConnected = SpotifyAuth.isConnected();
    this.updateSpotifyUI();
    if (this.spotifyConnected) { 
      const token = await SpotifyAuth.getValidToken(); 
      if (token) { await SpotifyPlayer.init(token); } 
    }
    this.timer = new SessionTimer(CONFIG.TIMER_MINUTES, (d) => this._onTimer(d), () => this._onComplete());
    if (saved?.timerEnabled) { this.timerOn = true; this.timer.start(); }
    this._bind(); this._render(); this._shortcuts();
    this.els.statusText.textContent = `v${APP_VERSION}`;
  }
  
  async fetchAllMetadata() {
    this.els.syncIndicator.classList.add('show');
    const releases = [];
    for (let i = 0; i < CONFIG.DEFAULT_RELEASES.length; i++) {
      const item = CONFIG.DEFAULT_RELEASES[i];
      const meta = await Utils.fetchSpotifyMetadata(item.url);
      if (meta && meta.title) {
        const artistData = Utils.getArtistForTitle(meta.title);
        releases.push({ title: meta.title, artist: artistData.artist, artistUrl: artistData.artistUrl, accentColor: artistData.accentColor, type: item.type, url: item.url });
      }
    }
    this.queue = new ReleaseQueue(releases); this.idx = 0; this._save();
    this.els.syncIndicator.classList.remove('show');
  }
  
  updateSpotifyUI() {
    if (this.spotifyConnected) {
      this.els.btnConnectSpotify.classList.add('connected');
      this.els.connectSpotifyText.textContent = 'Spotify –ø–æ–¥–∫–ª—é—á—ë–Ω';
      this.els.statusDot.classList.remove('offline');
      this.els.playbackControls.classList.remove('hidden');
      this.els.btnPlayPause.classList.remove('hidden');
    } else {
      this.els.btnConnectSpotify.classList.remove('connected');
      this.els.connectSpotifyText.textContent = '–ü–æ–¥–∫–ª—é—á–∏—Ç—å Spotify';
      this.els.statusDot.classList.add('offline');
      this.els.playbackControls.classList.add('hidden');
      this.els.btnPlayPause.classList.add('hidden');
    }
  }
  
  updatePlaybackUI() {
    if (SpotifyPlayer.isPlaying) {
      this.els.playPauseIcon.textContent = '‚è∏'; this.els.playPauseText.textContent = '–ü–∞—É–∑–∞';
      this.els.btnPlayPauseTrack.textContent = '‚è∏'; this.els.nowPlayingIndicator.classList.remove('hidden');
    } else {
      this.els.playPauseIcon.textContent = '‚ñ∂'; this.els.playPauseText.textContent = '–ò–≥—Ä–∞—Ç—å';
      this.els.btnPlayPauseTrack.textContent = '‚ñ∂'; this.els.nowPlayingIndicator.classList.add('hidden');
    }
  }
  
  _bind() {
    this.els.btnOpen.onclick = () => this.open();
    this.els.btnPrev.onclick = () => this.prev();
    this.els.btnNext.onclick = () => this.next();
    this.els.timerBtn.onclick = () => this.toggleTimer();
    this.els.artist.onclick = () => this.openArtist();
    
    this.els.btnConnectSpotify.onclick = async () => {
      if (this.spotifyConnected) {
        SpotifyAuth.disconnect(); SpotifyPlayer.disconnect();
        this.spotifyConnected = false; this.updateSpotifyUI();
      } else {
        await SpotifyAuth.connect();
      }
    };
    
    // üîß –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ö–Ω–æ–ø–∫–∞ –ò–≥—Ä–∞—Ç—å —Ç–µ–ø–µ—Ä—å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –¢–ï–ö–£–©–ò–ô –∏–Ω–¥–µ–∫—Å
    this.els.btnPlayPause.onclick = async () => { 
      console.log('‚ñ∂Ô∏è Play button clicked, current idx:', this.idx);
      console.log('‚ñ∂Ô∏è Current item:', this.queue.get(this.idx));
      await this.playCurrent(); 
    };
    
    this.els.btnPlayPauseTrack.onclick = () => SpotifyPlayer.togglePlay();
    this.els.btnPrevTrack.onclick = () => SpotifyPlayer.prevTrack();
    this.els.btnNextTrack.onclick = () => SpotifyPlayer.nextTrack();
    this.els.volumeSlider.oninput = (e) => SpotifyPlayer.setVolume(e.target.value);
    
    this.els.newArtist.addEventListener('input', () => { Utils.updateColorFromArtist(this.els.newArtist, this.els.newColor); });
    this.els.form.onsubmit = (e) => {
      e.preventDefault();
      const title = document.getElementById('newTitle').value.trim();
      const artistInput = document.getElementById('newArtist').value.trim();
      let artist = artistInput; let accentColor = document.getElementById('newColor').value;
      if (!artist) { const artistData = Utils.getArtistForTitle(title); artist = artistData.artist; accentColor = artistData.accentColor; }
      const data = { title, artist, accentColor, type: document.getElementById('newType').value, url: document.getElementById('newUrl').value.trim(), artistUrl: artistInput ? `https://open.spotify.com/search/${encodeURIComponent(artistInput)}` : '' };
      if (data.title && data.url) { this.queue.add(data); this._renderList(); this._save(); this.els.form.reset(); document.getElementById('newColor').value = '#38bdf8'; this._status('‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ'); }
    };
    this.els.editArtist.addEventListener('input', () => { Utils.updateColorFromArtist(this.els.editArtist, this.els.editColor, this.els.editColorIndicator); });
    this.els.modalClose.onclick = () => this._closeModal();
    this.els.editModal.onclick = (e) => { if (e.target === this.els.editModal) this._closeModal(); };
    document.onkeydown = (e) => { if (e.key === 'Escape' && this.els.editModal.classList.contains('show')) this._closeModal(); };
    this.els.btnDeleteFromModal.onclick = () => {
      const index = parseInt(this.els.editIndex.value);
      if (confirm('–£–¥–∞–ª–∏—Ç—å?')) {
        this.queue.remove(index);
        if (this.idx >= this.queue.length) this.idx = Math.max(0, this.queue.length - 1);
        this._closeModal(); this._render(); this._save();
      }
    };
    this.els.editForm.onsubmit = (e) => {
      e.preventDefault();
      const index = parseInt(this.els.editIndex.value);
      const artistInput = this.els.editArtist.value.trim();
      let artist = artistInput; let accentColor = this.els.editColor.value;
      if (!artist) { const artistData = Utils.getArtistForTitle(this.els.editTitle.value); artist = artistData.artist; accentColor = artistData.accentColor; }
      const data = { title: this.els.editTitle.value.trim(), artist, accentColor, type: this.els.editType.value, url: this.els.editUrl.value.trim(), artistUrl: artistInput ? `https://open.spotify.com/search/${encodeURIComponent(artistInput)}` : '' };
      this.queue.update(index, data); this._closeModal(); this._render(); this._save();
    };
  }
  
  _openModal(index) {
    const item = this.queue.get(index); if (!item) return;
    this.els.editIndex.value = index; this.els.editTitle.value = item.title;
    this.els.editArtist.value = item.artist || ''; this.els.editColor.value = item.accentColor || '#38bdf8';
    this.els.editType.value = item.type; this.els.editUrl.value = item.url;
    if (this.els.editColorIndicator) { this.els.editColorIndicator.style.backgroundColor = item.accentColor || '#38bdf8'; this.els.editColorIndicator.style.borderColor = item.accentColor || '#38bdf8'; }
    this.els.editModal.classList.add('show');
  }
  
  _closeModal() { this.els.editModal.classList.remove('show'); }
  
  _shortcuts() {
    document.onkeydown = (e) => {
      if (e.target.tagName === 'INPUT' || e.target.tagName === 'SELECT') return;
      if (this.els.editModal.classList.contains('show')) return;
      if (e.key === 'ArrowLeft') { e.preventDefault(); this.prev(); }
      if (e.key === 'ArrowRight') { e.preventDefault(); this.next(); }
      if (e.key === ' ') { e.preventDefault(); this.open(); }
      if (e.key.toLowerCase() === 't') { e.preventDefault(); this.toggleTimer(); }
    };
  }
  
  _render() { this._renderCurrent(); this._renderList(); this._updateTimerUI(); }
  
  _renderCurrent() {
    const item = this.queue.get(this.idx); if (!item) return;
    const color = item.accentColor || '#38bdf8';
    this.els.card.style.borderLeft = `4px solid ${color}`;
    this.els.title.textContent = item.title || '‚Äî';
    this.els.type.textContent = item.type === 'playlist' ? '–ü–õ–ï–ô–õ–ò–°–¢' : '–ê–õ–¨–ë–û–ú';
    this.els.type.style.color = color;
    this.els.artist.textContent = item.artist || 'Wordless Melodies Studio';
    this.els.artist.style.color = color;
    this.els.index.textContent = `${this.idx + 1} / ${this.queue.length}`;
  }
  
  _renderList() {
    this.els.list.innerHTML = '<div class="list-title">–û—á–µ—Ä–µ–¥—å —Ä–µ–ª–∏–∑–æ–≤</div>';
    this.queue.items.forEach((item, i) => {
      const color = item.accentColor || '#38bdf8';
      const row = document.createElement('div');
      row.className = `list-item${i === this.idx ? ' active' : ''}`;
      row.style.borderLeft = `4px solid ${color}`; row.style.paddingLeft = '8px';
      const dot = document.createElement('div'); dot.className = 'index-dot'; dot.style.backgroundColor = color;
      const badge = document.createElement('span'); badge.className = `badge ${item.type}`; badge.textContent = item.type === 'playlist' ? 'PLAYLIST' : 'ALBUM'; badge.style.borderColor = color; badge.style.color = color;
      const content = document.createElement('div'); content.className = 'list-content';
      const title = document.createElement('div'); title.className = 'list-title-text'; title.textContent = `üéµ ${item.title || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è'}`; content.appendChild(title);
      const artistDiv = document.createElement('div'); artistDiv.className = 'list-artist'; artistDiv.textContent = item.artist || 'Wordless Melodies Studio'; artistDiv.style.color = color;
      if (item.artistUrl) { artistDiv.onclick = (e) => { e.stopPropagation(); Utils.openUrl(item.artistUrl); }; }
      content.appendChild(artistDiv);
      const actions = document.createElement('div'); actions.className = 'list-actions';
      const editBtn = document.createElement('button'); editBtn.className = 'btn-edit btn-small'; editBtn.textContent = '‚úèÔ∏è'; editBtn.onclick = (e) => { e.stopPropagation(); this._openModal(i); };
      const deleteBtn = document.createElement('button'); deleteBtn.className = 'btn-danger btn-small'; deleteBtn.textContent = 'üóëÔ∏è'; deleteBtn.onclick = (e) => { e.stopPropagation(); if (confirm('–£–¥–∞–ª–∏—Ç—å?')) { this.queue.remove(i); if (this.idx >= this.queue.length) this.idx = Math.max(0, this.queue.length - 1); this._render(); this._save(); } };
      actions.appendChild(editBtn); actions.appendChild(deleteBtn);
      row.appendChild(dot); row.appendChild(badge); row.appendChild(content); row.appendChild(actions);
      row.onclick = () => { this.idx = i; console.log('üìç Selected index:', i, 'Title:', item.title); this._render(); this._save(); };
      this.els.list.appendChild(row);
    });
  }
  
  _updateTimerUI() { if (!this.timerOn) { this.els.timerLabel.textContent = '–¢–∞–π–º–µ—Ä –≤—ã–∫–ª—é—á–µ–Ω'; this.els.timeline.style.width = '0%'; return; } }
  _onTimer({progress, remaining}) { this.els.timeline.style.width = `${progress * 100}%`; this.els.timerLabel.textContent = `–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å—Å—è —á–µ—Ä–µ–∑ ${Utils.formatTime(remaining)}`; }
  _onComplete() { this.els.timerLabel.textContent = '‚è∞ –í—Ä–µ–º—è —Å–º–µ–Ω–∏—Ç—å —Ä–µ–ª–∏–∑'; this.els.timerLabel.style.color = 'var(--danger)'; }
  
  open() { 
    const item = this.queue.get(this.idx); if (!item) return; 
    if (this.spotifyConnected) { this.playCurrent(); } else { Utils.openUrl(item.url); } 
    if (this.timerOn) this.timer.reset(); 
  }
  
  // üîß –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –¢–µ–ø–µ—Ä—å —Ç–æ—á–Ω–æ –±–µ—Ä—ë—Ç —Ç–µ–∫—É—â–∏–π –∏–Ω–¥–µ–∫—Å
  async playCurrent() {
    const item = this.queue.get(this.idx);
    if (!item) { console.error('‚ùå No item at idx', this.idx); return; }
    
    const uri = Utils.getSpotifyUri(item.url);
    if (!uri) { Utils.openUrl(item.url); return; }
    
    console.log('üéµ Playing:', item.title, 'URI:', uri, 'Idx:', this.idx);
    
    const token = await SpotifyAuth.getValidToken();
    if (!token) { alert('–°–µ—Å—Å–∏—è –∏—Å—Ç–µ–∫–ª–∞. –ü–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–∏—Ç–µ—Å—å.'); return; }
    
    // üîß –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –∞–∫—Ç–∏–≤–∏—Ä—É–µ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –ø–µ—Ä–µ–¥ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ–º
    await fetch('https://api.spotify.com/v1/me/player', {
      method: 'PUT',
      headers: { 'Authorization': `Bearer ${token}` },
      body: JSON.stringify({ device_ids: [SpotifyPlayer.deviceId], play: true })
    });
    
    const success = await SpotifyPlayer.play(uri);
    this._status(success ? '‚ñ∂Ô∏è –ò–≥—Ä–∞–µ—Ç' : '‚ùå –û—à–∏–±–∫–∞');
  }
  
  openArtist() { const item = this.queue.get(this.idx); if (item?.artistUrl) { Utils.openUrl(item.artistUrl); } }
  prev() { this.idx = (this.idx - 1 + this.queue.length) % this.queue.length; this._render(); this._save(); }
  next() { this.idx = (this.idx + 1) % this.queue.length; this._render(); this._save(); }
  toggleTimer() {
    this.timerOn = !this.timerOn;
    if (this.timerOn) { this.timer.start(); this.els.timerBtnText.textContent = '–¢–∞–π–º–µ—Ä –≤–∫–ª.'; }
    else { this.timer.stop(); this.els.timerBtnText.textContent = '–¢–∞–π–º–µ—Ä –≤—ã–∫–ª.'; this.els.timerLabel.textContent = '–¢–∞–π–º–µ—Ä –≤—ã–∫–ª—é—á–µ–Ω'; this.els.timeline.style.width = '0%'; }
    this._save();
  }
  _save = Utils.debounce(() => Storage.save({ releases: this.queue.items, currentIndex: this.idx, timerEnabled: this.timerOn }), 300);
  _status(msg, t = 1500) { const orig = this.els.status.innerHTML; this.els.status.innerHTML = `<span class="tag-dot"></span><span>${msg}</span>`; setTimeout(() => { this.els.status.innerHTML = orig; this.els.statusText.textContent = `v${APP_VERSION}`; }, t); }
}

// === CALLBACK ===
const urlParams = new URLSearchParams(window.location.search);
const code = urlParams.get('code');
const error = urlParams.get('error');

if (error) {
  document.getElementById('mainApp').classList.add('hidden');
  document.getElementById('callbackPage').classList.remove('hidden');
  document.querySelector('.callback-message h1').textContent = '‚ùå –û—à–∏–±–∫–∞: ' + error;
} else if (code) {
  document.getElementById('mainApp').classList.add('hidden');
  document.getElementById('callbackPage').classList.remove('hidden');
  (async () => {
    try {
      await SpotifyAuth.getToken(code);
      await SpotifyPlayer.init(SpotifyAuth.accessToken);
      if (App.instance) { App.instance.spotifyConnected = true; App.instance.updateSpotifyUI(); }
      setTimeout(() => {
        window.history.replaceState({}, document.title, window.location.pathname);
        document.getElementById('callbackPage').classList.add('hidden');
        document.getElementById('mainApp').classList.remove('hidden');
      }, 2000);
    } catch (e) {
      console.error('Token error:', e);
    }
  })();
}

window.addEventListener('load', async () => {
  if (SpotifyAuth.isConnected() && !code) {
    const token = await SpotifyAuth.getValidToken();
    if (token) { await SpotifyPlayer.init(token); }
  }
});

document.addEventListener('DOMContentLoaded', () => {
  if (!code && !error) { new App(); }
});
</script>
</body>
</html>
